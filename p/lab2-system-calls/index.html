<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="MIT 6.S081 çš„ç¬¬äºŒæ¬¡å®éªŒï¼Œç¼–å†™ç³»ç»Ÿè°ƒç”¨ï¼Œå…·ä½“å®éªŒè¿‡ç¨‹ã€‚"><title>lab2: system calls</title><link rel=canonical href=https://XieWeikai.github.io/aniya_blog/p/lab2-system-calls/><link rel=stylesheet href=/aniya_blog/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property="og:title" content="lab2: system calls"><meta property="og:description" content="MIT 6.S081 çš„ç¬¬äºŒæ¬¡å®éªŒï¼Œç¼–å†™ç³»ç»Ÿè°ƒç”¨ï¼Œå…·ä½“å®éªŒè¿‡ç¨‹ã€‚"><meta property="og:url" content="https://XieWeikai.github.io/aniya_blog/p/lab2-system-calls/"><meta property="og:site_name" content="Aniya's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2023-01-06T22:37:47+08:00"><meta property="article:modified_time" content="2023-01-06T22:37:47+08:00"><meta property="og:image" content="https://XieWeikai.github.io/aniya_blog/p/lab2-system-calls/cover.jpg"><meta name=twitter:title content="lab2: system calls"><meta name=twitter:description content="MIT 6.S081 çš„ç¬¬äºŒæ¬¡å®éªŒï¼Œç¼–å†™ç³»ç»Ÿè°ƒç”¨ï¼Œå…·ä½“å®éªŒè¿‡ç¨‹ã€‚"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://XieWeikai.github.io/aniya_blog/p/lab2-system-calls/cover.jpg"><link rel="shortcut icon" href=/aniya_blog/aniya.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/aniya_blog><img src=/aniya_blog/img/aniya_hu746a8935f3131bdc51d8425bcf15aebb_113600_300x0_resize_q75_box.jpeg width=300 height=188 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ¤¤</span></figure><div class=site-meta><h1 class=site-name><a href=/aniya_blog>Aniya's Blog</a></h1><h2 class=site-description>Just for fun.</h2></div></header><ol class=social-menu><li><a href=https://github.com/XieWeikai target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/aniya_blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/aniya_blog/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/aniya_blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/aniya_blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/aniya_blog/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://XieWeikai.github.io/aniya_blog/ selected>ä¸­æ–‡</option><option value=https://XieWeikai.github.io/aniya_blog/en/>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#å‡†å¤‡>å‡†å¤‡</a><ol><li><a href=#å¯åŠ¨æµç¨‹æ¦‚è¿°>å¯åŠ¨æµç¨‹æ¦‚è¿°</a></li><li><a href=#ç³»ç»Ÿè°ƒç”¨>ç³»ç»Ÿè°ƒç”¨</a></li><li><a href=#è·å–å‚æ•°>è·å–å‚æ•°</a></li><li><a href=#ç”¨æˆ·æ€stub>ç”¨æˆ·æ€stub</a></li><li><a href=#ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®ä¼ è¾“>ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®ä¼ è¾“</a></li></ol></li><li><a href=#å®éªŒ>å®éªŒ</a><ol><li><a href=#trace>trace</a></li><li><a href=#sysinfo>sysinfo</a></li></ol></li><li><a href=#å°¾å£°>å°¾å£°</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/aniya_blog/p/lab2-system-calls/><img src=/aniya_blog/p/lab2-system-calls/cover_hu7ace472778f385b50e7c8f287dbb6c46_2544271_800x0_resize_q75_box.jpg srcset="/aniya_blog/p/lab2-system-calls/cover_hu7ace472778f385b50e7c8f287dbb6c46_2544271_800x0_resize_q75_box.jpg 800w, /aniya_blog/p/lab2-system-calls/cover_hu7ace472778f385b50e7c8f287dbb6c46_2544271_1600x0_resize_q75_box.jpg 1600w" width=800 height=559 loading=lazy alt="Featured image of post lab2: system calls"></a></div><div class=article-details><header class=article-category><a href=/aniya_blog/categories/os/ style=background-color:#2a9d8f;color:#fff>OS</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/aniya_blog/p/lab2-system-calls/>lab2: system calls</a></h2><h3 class=article-subtitle>MIT 6.S081 çš„ç¬¬äºŒæ¬¡å®éªŒï¼Œç¼–å†™ç³»ç»Ÿè°ƒç”¨ï¼Œå…·ä½“å®éªŒè¿‡ç¨‹ã€‚</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 06, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 14 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=os-lab-syscall>OS lab syscall</h1><p>æ—¶éš”ä¸€å¤©ï¼Œå±…ç„¶åˆè±¡å¾æ€§çš„å®Œæˆäº†ä¸€ä¸ªå®éªŒğŸ˜‹</p><p>æœ¬æ¬¡å®éªŒéœ€è¦åœ¨xv6ç³»ç»Ÿå†…é¢å¤–æ·»åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†åˆ«æ˜¯<code>trace</code>å’Œ<code>sysinfo</code>ï¼Œ<code>trace</code>ç”¨äºè·Ÿè¸ªæŸä¸ªè¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µï¼Œ<code>sysinfo</code>ç”¨äºæŸ¥çœ‹ç³»ç»Ÿå†…ç©ºé—²å†…å­˜å’Œè¿›ç¨‹ä¸ªæ•°ã€‚</p><p>å®éªŒçš„å®˜æ–¹æŒ‡å¯¼è§ <a class=link href=https://pdos.csail.mit.edu/6.828/2020/labs/syscall.html target=_blank rel=noopener>https://pdos.csail.mit.edu/6.828/2020/labs/syscall.html</a> ã€‚</p><h2 id=å‡†å¤‡>å‡†å¤‡</h2><p>å®˜æ–¹<a class=link href=https://pdos.csail.mit.edu/6.828/2020/labs/syscall.html target=_blank rel=noopener>æŒ‡å¯¼</a>ä¸­çš„å‰ç½®è¦æ±‚æ˜¯</p><blockquote><p>Before you start coding, read Chapter 2 of the <a class=link href=https://pdos.csail.mit.edu/6.828/2020/xv6/book-riscv-rev1.pdf target=_blank rel=noopener>xv6 book</a>, and Sections 4.3 and 4.4 of Chapter 4, and related source files:</p><ul><li>The user-space code for systems calls is in <code>user/user.h</code> and <code>user/usys.pl</code>.</li><li>The kernel-space code is <code>kernel/syscall.h</code>, <code>kernel/syscall.c</code>.</li><li>The process-related code is <code>kernel/proc.h</code> and <code>kernel/proc.c</code>.</li></ul></blockquote><p>æŒ‡å¯¼ä¹¦ä¸­çš„Chapter 2æè¿°äº†æ“ä½œç³»ç»Ÿçš„ç»„ç»‡ç»“æ„ï¼Œå†…å®¹å¤§æ¦‚æ˜¯ç®€å•è®²äº†ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ä½œç”¨ã€æ“ä½œç³»ç»Ÿä¸ºä»€ä¹ˆé‡è¦ã€æœ‰å“ªäº›ç»„ç»‡æ“ä½œç³»ç»Ÿå„ä¸ªéƒ¨åˆ†çš„æ–¹æ³•ç­‰ç­‰ã€‚</p><p>åœ¨Chapter 2çš„æœ€åå¤§æ¦‚è®²äº†è®²xv6çš„å¯åŠ¨è¿‡ç¨‹ã€‚</p><h3 id=å¯åŠ¨æµç¨‹æ¦‚è¿°>å¯åŠ¨æµç¨‹æ¦‚è¿°</h3><p>qemuæ¨¡æ‹Ÿçš„æœºå™¨å¯åŠ¨æ—¶é¦–å…ˆæ‰§è¡ŒROMä¸­çš„ç¨‹åºï¼Œè¿™ä¸ªç¨‹åºçš„ä½œç”¨åº”è¯¥å°±æ˜¯å°†å¯åŠ¨åŒºçš„ä¸€éƒ¨åˆ†ä»£ç è½½å…¥å†…å­˜å¹¶è½¬äº¤CPUä½¿ç”¨æƒåˆ°è½½å…¥çš„ä»£ç ï¼Œxv6æœ€åˆçš„ä»£ç è§<code>kernel/entry.S:6</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>				# qemu -kernel loads the kernel at 0x80000000
</span></span><span class=line><span class=cl>        # and causes each CPU to jump there.
</span></span><span class=line><span class=cl>        # kernel.ld causes the following code to
</span></span><span class=line><span class=cl>        # be placed at 0x80000000.
</span></span><span class=line><span class=cl>.section .text
</span></span><span class=line><span class=cl>_entry:
</span></span><span class=line><span class=cl>				# set up a stack for C.
</span></span><span class=line><span class=cl>        # stack0 is declared in start.c,
</span></span><span class=line><span class=cl>        # with a 4096-byte stack per CPU.
</span></span><span class=line><span class=cl>        # sp = stack0 + (hartid * 4096)
</span></span><span class=line><span class=cl>        la sp, stack0
</span></span><span class=line><span class=cl>        li a0, 1024*4
</span></span><span class=line><span class=cl>				csrr a1, mhartid
</span></span><span class=line><span class=cl>        addi a1, a1, 1
</span></span><span class=line><span class=cl>        mul a0, a0, a1
</span></span><span class=line><span class=cl>        add sp, sp, a0
</span></span><span class=line><span class=cl>				# jump to start() in start.c
</span></span><span class=line><span class=cl>        call start
</span></span><span class=line><span class=cl>spin:
</span></span><span class=line><span class=cl>        j spin
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„æ±‡ç¼–ä»£ç è®¾ç½®å¥½æ ˆé¡¶å¯„å­˜å™¨åå°†è·³è½¬åˆ° <code>kernel/start.c</code>ä¸­çš„<code>start</code>å‡½æ•°ï¼Œæ³¨æ„åœ¨æœºå™¨åˆšå¯åŠ¨æ—¶å¤„åœ¨<code>machine mode</code>ï¼Œè¯¥æ¨¡å¼ä¸‹æ‹¥æœ‰æ‰€æœ‰çš„æƒé™ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// entry.S jumps here in machine mode on stack0.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// set M Previous Privilege mode to Supervisor, for mret.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>x</span> <span class=o>=</span> <span class=nf>r_mstatus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>x</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>MSTATUS_MPP_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>x</span> <span class=o>|=</span> <span class=n>MSTATUS_MPP_S</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>w_mstatus</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// set M Exception Program Counter to main, for mret.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// requires gcc -mcmodel=medany
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>w_mepc</span><span class=p>((</span><span class=n>uint64</span><span class=p>)</span><span class=n>main</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// disable paging for now.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>w_satp</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// delegate all interrupts and exceptions to supervisor mode.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>w_medeleg</span><span class=p>(</span><span class=mh>0xffff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>w_mideleg</span><span class=p>(</span><span class=mh>0xffff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>w_sie</span><span class=p>(</span><span class=nf>r_sie</span><span class=p>()</span> <span class=o>|</span> <span class=n>SIE_SEIE</span> <span class=o>|</span> <span class=n>SIE_STIE</span> <span class=o>|</span> <span class=n>SIE_SSIE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ask for clock interrupts.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>timerinit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// keep each CPU&#39;s hartid in its tp register, for cpuid().
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=nf>r_mhartid</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>w_tp</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// switch to supervisor mode and jump to main().
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>asm</span> <span class=k>volatile</span><span class=p>(</span><span class=s>&#34;mret&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä»£ç å¯¹æœºå™¨è¿›è¡Œäº†ä¸€äº›è®¾ç½®ï¼Œæ²¡äº†è§£è¿‡riscvçš„å¤„ç†å™¨ï¼Œéšç€å®éªŒçš„æ·±å…¥åº”è¯¥ä¹Ÿè®¸ä¼šäº†è§£æ›´å¤šå§ï¼Œä¸Šé¢ä»£ç çš„æœ€åä¸€å¥ï¼Œä½¿ç”¨æ±‡ç¼–<code>mret</code>ï¼Œè¿™ä¸€èˆ¬ç”¨äº<code>supervisor mode</code>è°ƒç”¨<code>machine mode</code>çš„ä»£ç åä»<code>machine mode</code>è¿”å›<code>supervisor mode</code>ï¼Œåœ¨è¿™ä¸ªä»£ç é‡Œé€šè¿‡<code>mret</code>è¿›å…¥<code>supervisor mode</code>ï¼Œä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œçš„æ¨¡å¼ï¼Œåœ¨<code>start</code>å‡½æ•°å‰é¢ä¸€äº›ä»£ç å·²ç»å°†è¿”å›åœ°å€è®¾ä¸ºäº†<code>main</code>ï¼Œæ•…<code>mret</code>ä¼šè½¬åˆ°<code>main</code>å‡½æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// start() jumps here in supervisor mode on all CPUs.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>cpuid</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>consoleinit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>printfinit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;xv6 kernel is booting</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>kinit</span><span class=p>();</span>         <span class=c1>// physical page allocator
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>kvminit</span><span class=p>();</span>       <span class=c1>// create kernel page table
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>kvminithart</span><span class=p>();</span>   <span class=c1>// turn on paging
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>procinit</span><span class=p>();</span>      <span class=c1>// process table
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>trapinit</span><span class=p>();</span>      <span class=c1>// trap vectors
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>trapinithart</span><span class=p>();</span>  <span class=c1>// install kernel trap vector
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>plicinit</span><span class=p>();</span>      <span class=c1>// set up interrupt controller
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>plicinithart</span><span class=p>();</span>  <span class=c1>// ask PLIC for device interrupts
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>binit</span><span class=p>();</span>         <span class=c1>// buffer cache
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>iinit</span><span class=p>();</span>         <span class=c1>// inode cache
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>fileinit</span><span class=p>();</span>      <span class=c1>// file table
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>virtio_disk_init</span><span class=p>();</span> <span class=c1>// emulated hard disk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>userinit</span><span class=p>();</span>      <span class=c1>// first user process
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>__sync_synchronize</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>started</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>started</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>__sync_synchronize</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;hart %d starting</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>cpuid</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=nf>kvminithart</span><span class=p>();</span>    <span class=c1>// turn on paging
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>trapinithart</span><span class=p>();</span>   <span class=c1>// install kernel trap vector
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>plicinithart</span><span class=p>();</span>   <span class=c1>// ask PLIC for device interrupts
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>scheduler</span><span class=p>();</span>        
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>main</code>å‡½æ•°å†…è¿›è¡Œäº†ä¸€å †åˆå§‹åŒ–æ“ä½œï¼Œæœ€åè°ƒç”¨äº†<code>userinit()</code>å‡½æ•°å¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè¯¥å‡½æ•°ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Set up first user process.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>userinit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=nf>allocproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>initproc</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// allocate one user page and copy init&#39;s instructions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// and data into it.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>uvminit</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>initcode</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>initcode</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// prepare for the very first &#34;return&#34; from kernel to user.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>      <span class=c1>// user program counter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span> <span class=o>=</span> <span class=n>PGSIZE</span><span class=p>;</span>  <span class=c1>// user stack pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>safestrcpy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;initcode&#34;</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>cwd</span> <span class=o>=</span> <span class=nf>namei</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä»£ç åœ¨å¯¹è¿›ç¨‹ä¸€äº›å¿…è¦çš„ä¸œè¥¿åˆå§‹åŒ–åå¯åŠ¨äº†<code>initcode</code>è¿™ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ˜¯ç”¨æ±‡ç¼–å†™çš„ï¼Œä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>#include &#34;syscall.h&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># exec(init, argv)
</span></span><span class=line><span class=cl>.globl start
</span></span><span class=line><span class=cl>start:
</span></span><span class=line><span class=cl>        la a0, init
</span></span><span class=line><span class=cl>        la a1, argv
</span></span><span class=line><span class=cl>        li a7, SYS_exec
</span></span><span class=line><span class=cl>        ecall
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># for(;;) exit();
</span></span><span class=line><span class=cl>exit:
</span></span><span class=line><span class=cl>        li a7, SYS_exit
</span></span><span class=line><span class=cl>        ecall
</span></span><span class=line><span class=cl>        jal exit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># char init[] = &#34;/init\0&#34;;
</span></span><span class=line><span class=cl>init:
</span></span><span class=line><span class=cl>  .string &#34;/init\0&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># char *argv[] = { init, 0 };
</span></span><span class=line><span class=cl>.p2align 2
</span></span><span class=line><span class=cl>argv:
</span></span><span class=line><span class=cl>  .long init
</span></span><span class=line><span class=cl>  .long 0
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢çš„ä»£ç ç›¸å½“äºæ‰§è¡Œäº†cç¨‹åº</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>start</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>init</span> <span class=o>=</span> <span class=s>&#34;/init&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=n>init</span><span class=p>,</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nf>exec</span><span class=p>(</span><span class=n>init</span><span class=p>,</span><span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(;;)</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ª<code>/init</code>ç¨‹åºè§æºç <code>user/init.c</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// init: The initial user-level program
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/types.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/stat.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/spinlock.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/sleeplock.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/fs.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/file.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;user/user.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;kernel/fcntl.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span> <span class=s>&#34;sh&#34;</span><span class=p>,</span> <span class=mi>0</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>pid</span><span class=p>,</span> <span class=n>wpid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>open</span><span class=p>(</span><span class=s>&#34;console&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>mknod</span><span class=p>(</span><span class=s>&#34;console&#34;</span><span class=p>,</span> <span class=n>CONSOLE</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>open</span><span class=p>(</span><span class=s>&#34;console&#34;</span><span class=p>,</span> <span class=n>O_RDWR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>dup</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>  <span class=c1>// stdout
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>dup</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>  <span class=c1>// stderr
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(;;){</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;init: starting sh</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>pid</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;init: fork failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>pid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=nf>exec</span><span class=p>(</span><span class=s>&#34;sh&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;init: exec sh failed</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(;;){</span>
</span></span><span class=line><span class=cl>      <span class=c1>// this call to wait() returns if the shell exits,
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// or if a parentless process exits.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>wpid</span> <span class=o>=</span> <span class=nf>wait</span><span class=p>((</span><span class=kt>int</span> <span class=o>*</span><span class=p>)</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span><span class=p>(</span><span class=n>wpid</span> <span class=o>==</span> <span class=n>pid</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=c1>// the shell exited; restart it.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>wpid</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;init: wait returned an error</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// it was a parentless process; do nothing.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¼•ç”¨æŒ‡å¯¼ä¹¦çš„è¯ï¼Œ<code>init</code>ç¨‹åºå¹²çš„äº‹ä¸º</p><blockquote><p>Init (user/init.c:15) creates a new console device fifile if needed and then opens it as fifile descriptors 0, 1, and 2. Then it starts a shell on the console. The system is up.</p></blockquote><p>xv6å¤§è‡´çš„å¯åŠ¨æµç¨‹åˆ°æ­¤ç»“æŸï¼Œå…¶å®è¿˜æ˜¯æ¯”è¾ƒæ¨¡ç³Šçš„ï¼Œç»†èŠ‚åº”è¯¥ä¼šåœ¨åé¢çš„å®éªŒé€æ¸å±•å¼€ &mldr; å§ğŸ¤£</p><hr><h3 id=ç³»ç»Ÿè°ƒç”¨>ç³»ç»Ÿè°ƒç”¨</h3><p>åœ¨å®éªŒæŒ‡å¯¼<a class=link href=https://pdos.csail.mit.edu/6.828/2020/labs/syscall.html target=_blank rel=noopener>ç½‘ç«™</a>ä¸­è¿˜æåˆ°è¦çœ‹æŒ‡å¯¼ä¹¦çš„4.3å’Œ4.4èŠ‚ï¼Œè¿™ä¸¤èŠ‚è±¡å¾æ€§çš„è®²äº†ä¸‹ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„ä»£ç ï¼Œç»†èŠ‚ä¸è¡¨ï¼Œå¤§æ¦‚æµç¨‹åœ¨æœ¬èŠ‚ç²—ç•¥çš„è§£é‡Šä¸€ä¸‹ã€‚</p><p>é¦–å…ˆåœ¨ä¸Šä¸€èŠ‚ä¸­å…¶å®çœ‹åˆ°äº†æ±‡ç¼–å¦‚ä½•è°ƒç”¨execç³»ç»Ÿè°ƒç”¨çš„ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>la a0, init
</span></span><span class=line><span class=cl>la a1, argv
</span></span><span class=line><span class=cl>li a7, SYS_exec
</span></span><span class=line><span class=cl>ecall
</span></span></code></pre></td></tr></table></div></div><p>riscvå†…æœ‰a0-a7è¿™å‡ ä¸ªå¯„å­˜å™¨ï¼ˆæŒ‰ç…§æƒ¯ä¾‹ï¼‰ç”¨äºä¼ é€’å‚æ•°(aå°±æ˜¯arg)ï¼Œexecéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«å­˜å…¥a0,a1ä¸­ï¼Œa7ç”¨äºå­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·ã€‚ecallæŒ‡ä»¤ä¼šé™·å…¥å†…æ ¸(å…·ä½“å“ªé‡Œä»¥ååº”è¯¥ä¼šçŸ¥é“çš„)ï¼Œé™·å…¥å†…æ ¸åä¾æ¬¡æ‰§è¡Œ<code>uservec</code>ã€<code>usertrap</code>ç„¶åæ˜¯<code>syscall</code>ï¼Œæœ€åè¿™ä¸ª<code>syscall</code>å‡½æ•°çœŸæ­£è°ƒç”¨äº†ç³»ç»Ÿè°ƒç”¨ã€‚è¯¥å‡½æ•°è§<code>kernel/syscall.c</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>syscall</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>num</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>num</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>num</span> <span class=o>&lt;</span> <span class=nf>NELEM</span><span class=p>(</span><span class=n>syscalls</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>]();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d %s: unknown sys call %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…ˆæ³¨æ„ä¸Šé¢çš„<code>myproc</code>ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªè¿›ç¨‹(ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹)ç›¸å…³çš„ç»“æ„ä½“(åº”è¯¥å°±æ˜¯ç†è®ºå­¦ä¹ ä¸­çš„PCBäº†å§)ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Per-process state
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>spinlock</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// p-&gt;lock must be held when using these:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>enum</span> <span class=n>procstate</span> <span class=n>state</span><span class=p>;</span>        <span class=c1>// Process state
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>parent</span><span class=p>;</span>         <span class=c1>// Parent process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>chan</span><span class=p>;</span>                  <span class=c1>// If non-zero, sleeping on chan
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>killed</span><span class=p>;</span>                  <span class=c1>// If non-zero, have been killed
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>xstate</span><span class=p>;</span>                  <span class=c1>// Exit status to be returned to parent&#39;s wait
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>pid</span><span class=p>;</span>                     <span class=c1>// Process ID
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// these are private to the process, so p-&gt;lock need not be held.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>kstack</span><span class=p>;</span>               <span class=c1>// Virtual address of kernel stack
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>sz</span><span class=p>;</span>                   <span class=c1>// Size of process memory (bytes)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>;</span>       <span class=c1>// User page table
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>trapframe</span> <span class=o>*</span><span class=n>trapframe</span><span class=p>;</span> <span class=c1>// data page for trampoline.S
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>context</span> <span class=n>context</span><span class=p>;</span>      <span class=c1>// swtch() here to run process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>ofile</span><span class=p>[</span><span class=n>NOFILE</span><span class=p>];</span>  <span class=c1>// Open files
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>cwd</span><span class=p>;</span>           <span class=c1>// Current directory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>               <span class=c1>// Process name (debugging)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢ç»“æ„ä¸­çš„<code>trapframe</code>å­˜ç€è¯¥è¿›ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€å’Œå…¶ä»–ä¸€äº›ä¿¡æ¯ï¼Œåœ¨å›è¿‡å¤´æ¥çœ‹<code>syscall</code>ä¸­çš„å¦‚ä¸‹ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>num</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a7</span><span class=p>;</span>  <span class=c1>// a7å­˜çš„æ˜¯è°ƒç”¨å·ï¼Œå¦‚å‰é¢æ±‡ç¼–è¯­è¨€è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ‰€ç¤º
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span><span class=p>(</span><span class=n>num</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>num</span> <span class=o>&lt;</span> <span class=nf>NELEM</span><span class=p>(</span><span class=n>syscalls</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>])</span> <span class=p>{</span> <span class=c1>// è°ƒç”¨å·æ»¡è¶³ä¸€å®šæ¡ä»¶æ‰èƒ½è°ƒç”¨ç³»ç»Ÿè°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>]();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è§£é‡Šè§æ³¨é‡Šï¼Œå†æ¥çœ‹çœ‹<code>syscalls</code>è¿™ä¸ªå˜é‡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=nf>uint64</span> <span class=p>(</span><span class=o>*</span><span class=n>syscalls</span><span class=p>[])(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_fork</span><span class=p>]</span>    <span class=n>sys_fork</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_exit</span><span class=p>]</span>    <span class=n>sys_exit</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_wait</span><span class=p>]</span>    <span class=n>sys_wait</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_pipe</span><span class=p>]</span>    <span class=n>sys_pipe</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_read</span><span class=p>]</span>    <span class=n>sys_read</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_kill</span><span class=p>]</span>    <span class=n>sys_kill</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_exec</span><span class=p>]</span>    <span class=n>sys_exec</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_fstat</span><span class=p>]</span>   <span class=n>sys_fstat</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_chdir</span><span class=p>]</span>   <span class=n>sys_chdir</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_dup</span><span class=p>]</span>     <span class=n>sys_dup</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_getpid</span><span class=p>]</span>  <span class=n>sys_getpid</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_sbrk</span><span class=p>]</span>    <span class=n>sys_sbrk</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_sleep</span><span class=p>]</span>   <span class=n>sys_sleep</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_uptime</span><span class=p>]</span>  <span class=n>sys_uptime</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_open</span><span class=p>]</span>    <span class=n>sys_open</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_write</span><span class=p>]</span>   <span class=n>sys_write</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_mknod</span><span class=p>]</span>   <span class=n>sys_mknod</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_unlink</span><span class=p>]</span>  <span class=n>sys_unlink</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_link</span><span class=p>]</span>    <span class=n>sys_link</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_mkdir</span><span class=p>]</span>   <span class=n>sys_mkdir</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>SYS_close</span><span class=p>]</span>   <span class=n>sys_close</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ˜¯ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆçš„æ•°ç»„ï¼ŒæŒ‡å‘çš„å‡½æ•°å½¢å¦‚<code>uint64 func_name(void )</code>ï¼Œè¿™ä¸€æ®µä»£ç ç»™è¯¥æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä¸­<code>sys_fork</code>ï¼Œ<code>sys_exit</code>ä¹‹ç±»çš„ä¸ºå…·ä½“çš„å‡½æ•°(å‡½æ•°å°±æ˜¯ä¸€å †æŒ‡ä»¤ï¼Œå‡½æ•°åå…¶å®å°±æ˜¯è¿™ä¸€å †æŒ‡ä»¤çš„é¦–åœ°å€)ï¼Œ<code>SYS_fork</code>ä¹‹ç±»çš„è¡¨æ˜æ•°ç»„ä¸‹æ ‡ï¼Œè¿™äº›å®å®šä¹‰åœ¨<code>syscall.h</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// System call numbers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define SYS_fork    1
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_exit    2
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_wait    3
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_pipe    4
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_read    5
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_kill    6
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_exec    7
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_fstat   8
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_chdir   9
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_dup    10
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_getpid 11
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_sbrk   12
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_sleep  13
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_uptime 14
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_open   15
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_write  16
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_mknod  17
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_unlink 18
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_link   19
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_mkdir  20
</span></span></span><span class=line><span class=cl><span class=cp>#define SYS_close  21
</span></span></span></code></pre></td></tr></table></div></div><hr><h3 id=è·å–å‚æ•°>è·å–å‚æ•°</h3><p>ä¸Šé¢çœ‹åˆ°äº†ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ï¼Œ<code>syscall</code>å®é™…ä¸Šæ˜¯æ ¹æ®<code>a7</code>ä¸­çš„è°ƒç”¨å·æ¥é€‰æ‹©æŸä¸ªå…·ä½“çš„å®ç°ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°æ¥å®Œæˆç³»ç»Ÿè°ƒç”¨çš„ã€‚ä¸Šä¸€å°èŠ‚çœ‹åˆ°ï¼Œ<code>syscall</code>è°ƒç”¨çš„å‡½æ•°åŸå‹ä¸º<code>uint64 func_name(void)</code>ï¼Œé‚£è¿™äº›å‡½æ•°å¦‚ä½•æ‹¿åˆ°ç”¨æˆ·ä¼ é€’çš„å‚æ•°å‘¢ï¼Ÿ</p><p>å®é™…ä¸Šé€šè¿‡é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„ä»£ç å°±å¯ä»¥çœ‹å‡ºæ¥äº†</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># è°ƒç”¨ exec(init,argv)
</span></span><span class=line><span class=cl>la a0, init
</span></span><span class=line><span class=cl>la a1, argv
</span></span><span class=line><span class=cl>li a7, SYS_exec
</span></span><span class=line><span class=cl>ecall
</span></span></code></pre></td></tr></table></div></div><p>å‚æ•°å­˜åœ¨äº†è¯¥è¿›ç¨‹çš„a0-a5å¯„å­˜å™¨ä¸­ï¼Œè€Œé€šè¿‡å‰æ–‡å¯ä»¥çœ‹åˆ°ï¼Œå¯ä»¥é€šè¿‡<code>myproc</code>æ‹¿åˆ°ç”¨æˆ·è¿›ç¨‹çš„<code>PCB</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>struct proc *</code>ï¼Œè¯¥ç»“æ„å†…çš„<code>trapframe</code>å†…æœ‰ç”¨æˆ·è¿›ç¨‹çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œæ¯”å¦‚<code>exec</code>è¦æ‹¿åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œåªéœ€è¦æ‹¿åˆ°a0å³å¯ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span>  <span class=c1>//  è¿™ä¸ªå€¼å°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨<code>kernel/syscall.c</code>ä¸­å·²ç»ç»™æˆ‘ä»¬å°è£…å¥½äº†ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>argraw</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=mi>4</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=mi>5</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;argraw&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>argraw(n)</code>å¯ä»¥æ‹¿åˆ°ç¬¬nä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯anå¯„å­˜å™¨çš„å€¼ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­è¿˜è¿›ä¸€æ­¥å°è£…äº†å¦å¤–å‡ ä¸ªå‡½æ•°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Fetch the nth 32-bit system call argument.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>argint</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=o>*</span><span class=n>ip</span><span class=p>)</span> <span class=c1>// è·å–æ•´æ•°ç±»å‹çš„å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>ip</span> <span class=o>=</span> <span class=nf>argraw</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Retrieve an argument as a pointer.
</span></span></span><span class=line><span class=cl><span class=c1>// Doesn&#39;t check for legality, since
</span></span></span><span class=line><span class=cl><span class=c1>// copyin/copyout will do that.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>argaddr</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>uint64</span> <span class=o>*</span><span class=n>ip</span><span class=p>)</span>  <span class=c1>// è·å–åœ°å€(æŒ‡é’ˆç±»å‹çš„å‚æ•°)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>ip</span> <span class=o>=</span> <span class=nf>argraw</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Fetch the nth word-sized system call argument as a null-terminated string.
</span></span></span><span class=line><span class=cl><span class=c1>// Copies into buf, at most max.
</span></span></span><span class=line><span class=cl><span class=c1>// Returns string length if OK (including nul), -1 if error.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>argstr</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>max</span><span class=p>)</span>  <span class=c1>// è·å–å­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>argaddr</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>addr</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// fetchstr ä»ç”¨æˆ·æ€çš„åœ°å€å¤„å°†å­—ç¬¦ä¸²å–å‡ºå¤åˆ¶åˆ°å†…æ ¸æ€ä¸­çš„bufå†… å†…æ ¸æ€å’Œç”¨æˆ·æ€
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// çš„åœ°å€ç©ºé—´ä¸ä¸€æ ·(é¡µè¡¨ä¸åŒ)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nf>fetchstr</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>max</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…·ä½“åŠŸèƒ½è§æ³¨é‡Šã€‚</p><hr><h3 id=ç”¨æˆ·æ€stub>ç”¨æˆ·æ€stub</h3><p>ä½œä¸ºç”¨æˆ·ï¼Œå¦‚æœå¸Œæœ›è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè‚¯å®šä¸å¸Œæœ›å†™æ±‡ç¼–æ¥è°ƒç”¨ï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·æ€ä¸‹éœ€è¦å°è£…ä¸€å±‚å‡½æ•°æ¥é™·å…¥å†…æ ¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ç”¨æˆ·å¸Œæœ›è°ƒç”¨æ–‡ä»¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨åªéœ€æŒ‰ç…§ä¸‹é¢çš„ä»£ç ä¹¦å†™</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>fd</span> <span class=o>=</span> <span class=nf>open</span><span class=p>(</span><span class=s>&#34;hello.txt&#34;</span><span class=p>,</span><span class=n>O_CREAT</span><span class=o>|</span><span class=n>O_WRONLY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>write</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=s>&#34;Hello,xv6!&#34;</span><span class=p>,</span><span class=mi>10</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>é‚£ä¹ˆä¸Šé¢è¿™äº›<code>open</code>ã€<code>write</code>çš„ä»£ç ç©¶ç«Ÿåœ¨å“ªé‡Œå‘¢ï¼Ÿè¿™äº›ä»£ç è¯¦è§<code>user/usys.S</code>ï¼Œæˆªå–è¿™ä¸¤ä¸ªå‡½æ•°ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.global open
</span></span><span class=line><span class=cl>open:
</span></span><span class=line><span class=cl> li a7, SYS_open
</span></span><span class=line><span class=cl> ecall
</span></span><span class=line><span class=cl> ret
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>.global write
</span></span><span class=line><span class=cl>write:
</span></span><span class=line><span class=cl> li a7, SYS_write
</span></span><span class=line><span class=cl> ecall
</span></span><span class=line><span class=cl> ret
</span></span></code></pre></td></tr></table></div></div><p>åœ¨ç”¨æˆ·æ€ç¼–å†™ä»£ç <code>func(a,b,c)</code>æ—¶ï¼Œå…¶å®å°±æ˜¯å°†a,b,cçš„å€¼è£…å…¥<code>a0</code>,<code>a1</code>,<code>a2</code>å¯„å­˜å™¨ï¼Œç„¶åå°†ä¸‹ä¸€è·³æŒ‡ä»¤åœ°å€ä¿å­˜åœ¨<code>ra</code>å¯„å­˜å™¨ï¼Œç„¶åè·³è½¬åˆ°<code>func</code>åœ°å€å¤„æ‰§è¡Œï¼Œä¸Šé¢çš„<code>open</code>å’Œ<code>write</code>å‡½æ•°åªéœ€è¦å‘<code>a7</code>å¯„å­˜å™¨è£…å…¥è°ƒç”¨å·ï¼Œå†ç”¨<code>ecall</code>å°±å¯ä»¥é™·å…¥å†…æ ¸è¿›è¡Œç³»ç»Ÿè°ƒç”¨äº†ã€‚</p><p>å¯ä»¥çœ‹è§è¿™äº›ä»£ç éƒ½éå¸¸çš„ä¸€è‡´ï¼Œè‡ªå·±æ‰‹å†™æ˜¾å¾—å¤ªå‚»äº†ï¼Œæ•…xv6æºç ä¸­ç”¨<code>usys.pl</code>è¿™ä¸ª<code>perl</code>è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ<code>usys.S</code>ï¼Œè¯¥è„šæœ¬å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/perl -w</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Generate usys.S, the stubs for syscalls.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=s>&#34;# generated by usys.pl - do not edit\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>print</span> <span class=s>&#34;#include \&#34;kernel/syscall.h\&#34;\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>entry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>my</span> <span class=nv>$name</span> <span class=o>=</span> <span class=nb>shift</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=s>&#34;.global $name\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=s>&#34;${name}:\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=s>&#34; li a7, SYS_${name}\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=s>&#34; ecall\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=s>&#34; ret\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl><span class=n>entry</span><span class=p>(</span><span class=s>&#34;fork&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>entry</span><span class=p>(</span><span class=s>&#34;exit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>...</span>  <span class=c1># æ¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å†™ä¸€ä¸ªentry(&#34;syscall_name&#34;)å³å¯</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>åˆ°è¿™é‡Œå°±åŸºæœ¬çŸ¥é“ç³»ç»Ÿè°ƒç”¨æ˜¯æ€ä¹ˆå›äº‹äº†ï¼Œè™½ç„¶å…·ä½“ç»†èŠ‚ä¸å¤ªæ¸…æ¥šï¼Œä½†çŸ¥é“ä¸ªå¤§æ¦‚æµç¨‹å°±å¯ä»¥å¼€å§‹åšæœ¬æ¬¡å®éªŒäº†ã€‚</p><hr><h3 id=ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®ä¼ è¾“>ç”¨æˆ·æ€å’Œå†…æ ¸æ€æ•°æ®ä¼ è¾“</h3><p>ç”±äºç”¨æˆ·æ€å’Œå†…æ ¸æ€åœ°å€ç©ºé—´ä¸ä¸€æ ·ï¼Œæ•…ä¸èƒ½ç®€å•çš„é€šè¿‡åœ°å€æ¥ä¼ å…¥æˆ–ä¼ å‡ºæ•°æ®ï¼Œæ¥çœ‹çœ‹<code>fstat</code>ç³»ç»Ÿè°ƒç”¨å¦‚ä½•ä¼ å‡º<code>struct stat</code>ç»“æ„ä½“åˆ°ç”¨æˆ·æ€ï¼Œçœ‹å…¶æºç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>sys_fstat</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>st</span><span class=p>;</span> <span class=c1>// user pointer to struct stat
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>argfd</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>f</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=nf>argaddr</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>st</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿™é‡Œè°ƒç”¨argaddr(1,&amp;st)åï¼Œstå³å­˜ç€ç”¨æˆ·ä¼ å…¥çš„struct stat*æŒ‡é’ˆçš„å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>filestat</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>st</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å†çœ‹çœ‹<code>filestat</code>çš„å®ç°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Get metadata about file f.
</span></span></span><span class=line><span class=cl><span class=c1>// addr is a user virtual address, pointing to a struct stat.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>filestat</span><span class=p>(</span><span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>stat</span> <span class=n>st</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>==</span> <span class=n>FD_INODE</span> <span class=o>||</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>==</span> <span class=n>FD_DEVICE</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>ilock</span><span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>stati</span><span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>st</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>iunlock</span><span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>copyout</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>st</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>st</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// æ³¨æ„è¿™é‡Œå°†å†…æ ¸æ€çš„ç»“æ„å¤åˆ¶åˆ°ç”¨æˆ·æ€çš„åœ°å€å¤„
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°éœ€è¦é€šè¿‡<code>copyout</code>å‡½æ•°æ¥å°†å†…æ ¸åœ°å€ç©ºé—´çš„æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·çš„åœ°å€ç©ºé—´ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ã€‚</p><hr><h2 id=å®éªŒ>å®éªŒ</h2><h3 id=trace>trace</h3><p>çœ‹çœ‹å®éªŒè¦åšä»€ä¹ˆ</p><blockquote><p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You&rsquo;ll create a new <code>trace</code> system call that will control tracing. It should take one argument, an integer &ldquo;mask&rdquo;, whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls <code>trace(1 &lt;&lt; SYS_fork)</code>, where <code>SYS_fork</code> is a syscall number from <code>kernel/syscall.h</code>. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call&rsquo;s number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don&rsquo;t need to print the system call arguments. The <code>trace</code> system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p></blockquote><p>å®éªŒåº”è¯¥è¾¾åˆ°çš„æ•ˆæœ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ trace <span class=m>32</span> grep hello README <span class=c1># 32 å°±æ˜¯ 1 &lt;&lt; SYS_read</span>
</span></span><span class=line><span class=cl>3: syscall <span class=nb>read</span> -&gt; <span class=m>1023</span>
</span></span><span class=line><span class=cl>3: syscall <span class=nb>read</span> -&gt; <span class=m>966</span>
</span></span><span class=line><span class=cl>3: syscall <span class=nb>read</span> -&gt; <span class=m>70</span>
</span></span><span class=line><span class=cl>3: syscall <span class=nb>read</span> -&gt; <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>æœ‰äº†å‰æ–‡çš„åŸºç¡€ï¼Œè¿™ä¸ªå®éªŒå…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆè¦æ‰¾ä¸ªåœ°æ–¹è®°å½•æŸä¸ªè¿›ç¨‹è¦traceçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¾ç„¶åœ¨<code>PCB</code>å³<code>struct proc</code>ä¸­è®°å½•è¿™ä¸ª<code>mask</code>æ¯”è¾ƒå¥½ï¼Œåœ¨è¯¥ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ª<code>mask</code>å­—æ®µå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Per-process state
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=c1>// for syscall trace
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>trace_mask</span><span class=p>;</span>  <span class=c1>// save the trace mask for a process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>é‚£ä¹ˆæ·»åŠ çš„ç³»ç»Ÿè°ƒç”¨åŠŸèƒ½å°±æ˜¯è®¾ç½®è¿›ç¨‹çš„<code>trace_mask</code>ï¼Œåœ¨<code>sysproc.c</code>ä¸­æ·»åŠ å¦‚ä¸‹ç³»ç»Ÿè°ƒç”¨å‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>sys_trace</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>mask</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=nf>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=o>&amp;</span><span class=n>mask</span><span class=p>);</span>  <span class=c1>// get the mask argment
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trace_mask</span> <span class=o>=</span> <span class=n>mask</span><span class=p>;</span>   <span class=c1>// save the trace mask
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨<code>syscall.h</code>ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨å·ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// System call numbers
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// added system call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define SYS_trace 22
</span></span></span></code></pre></td></tr></table></div></div><p>æ¥ç€ä¿®æ”¹<code>syscall.c</code>ä¸­çš„ç³»ç»Ÿè°ƒç”¨è¡¨ï¼Œæ·»åŠ ä¸€æ¡å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// added system call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>extern</span> <span class=n>uint64</span> <span class=nf>sys_trace</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>  <span class=c1>// declaration
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=nf>uint64</span> <span class=p>(</span><span class=o>*</span><span class=n>syscalls</span><span class=p>[])(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=c1>// added syscall
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>SYS_trace</span><span class=p>]</span>   <span class=n>sys_trace</span><span class=p>,</span>  <span class=c1>// æ·»åŠ ä¸€æ¡ç³»ç»Ÿè°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸ºäº†åœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶è¾“å‡ºç›¸å…³ä¿¡æ¯ï¼Œä»”ç»†æƒ³æƒ³ï¼Œæ¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¦ç»è¿‡<code>syscall</code>ï¼Œé‚£ä¹ˆå¯ä»¥ä¿®æ”¹<code>syscall</code>ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨åè¾“å‡º<code>trace</code>çš„ä¿¡æ¯ï¼Œä¿®æ”¹è¯¥å‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// è®°å½•ç³»ç»Ÿè°ƒç”¨åå­—
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=n>syscalls_names</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;none&#34;</span><span class=p>,</span><span class=s>&#34;fork&#34;</span><span class=p>,</span><span class=s>&#34;exit&#34;</span><span class=p>,</span><span class=s>&#34;wait&#34;</span><span class=p>,</span><span class=s>&#34;pipe&#34;</span><span class=p>,</span><span class=s>&#34;read&#34;</span><span class=p>,</span><span class=s>&#34;kill&#34;</span><span class=p>,</span><span class=s>&#34;exec&#34;</span><span class=p>,</span><span class=s>&#34;fstat&#34;</span><span class=p>,</span><span class=s>&#34;chdir&#34;</span><span class=p>,</span><span class=s>&#34;dup&#34;</span><span class=p>,</span><span class=s>&#34;getpid&#34;</span><span class=p>,</span><span class=s>&#34;sbrk&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;sleep&#34;</span><span class=p>,</span><span class=s>&#34;uptime&#34;</span><span class=p>,</span><span class=s>&#34;open&#34;</span><span class=p>,</span><span class=s>&#34;write&#34;</span><span class=p>,</span><span class=s>&#34;mknod&#34;</span><span class=p>,</span><span class=s>&#34;unlink&#34;</span><span class=p>,</span><span class=s>&#34;link&#34;</span><span class=p>,</span><span class=s>&#34;mkdir&#34;</span><span class=p>,</span><span class=s>&#34;close&#34;</span><span class=p>,</span><span class=s>&#34;trace&#34;</span><span class=p>,</span><span class=s>&#34;sysinfo&#34;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>syscall</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>num</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>num</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>num</span> <span class=o>&lt;</span> <span class=nf>NELEM</span><span class=p>(</span><span class=n>syscalls</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=n>syscalls</span><span class=p>[</span><span class=n>num</span><span class=p>]();</span> <span class=c1>// a0 ä¸­å­˜ç€è¿”å›å€¼
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>((</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trace_mask</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>num</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>){</span> <span class=c1>// it is a traced system call 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// å¦‚æœè¯¥ç³»ç»Ÿè°ƒç”¨çš„maskè®¾ç½®è¿‡äº†ï¼Œåˆ™è¾“å‡ºä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d: syscall %s -&gt; %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>,</span><span class=n>syscalls_names</span><span class=p>[</span><span class=n>num</span><span class=p>],</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%d %s: unknown sys call %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„æŒ‰ç…§ä»»åŠ¡è¦æ±‚ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹<code>trace</code>æŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆè¯¥è¿›è¡Œ<code>fork</code>å‡ºæ¥çš„å­è¿›ç¨‹ä¹Ÿè¦<code>trace</code>è¿™äº›ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>fork</code>ç³»ç»Ÿè°ƒç”¨ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>sys_fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æŸ¥çœ‹è¿™ä¸ª<code>fork</code>å‡½æ•°ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Create a new process, copying the parent.
</span></span></span><span class=line><span class=cl><span class=c1>// Sets up child kernel stack to return as if from fork() system call.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>np</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Allocate process.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>((</span><span class=n>np</span> <span class=o>=</span> <span class=nf>allocproc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Copy user memory from parent to child.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=nf>uvmcopy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>np</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>freeproc</span><span class=p>(</span><span class=n>np</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>parent</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// copy saved user registers.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>*</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Cause fork to return 0 in the child.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// increment reference counts on open file descriptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NOFILE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ofile</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=n>np</span><span class=o>-&gt;</span><span class=n>ofile</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>filedup</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ofile</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>cwd</span> <span class=o>=</span> <span class=nf>idup</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>cwd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>safestrcpy</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pid</span> <span class=o>=</span> <span class=n>np</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…·ä½“ç»†èŠ‚ä¸è°ˆï¼Œä½†ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ<code>p</code>æ˜¯å½“å‰è¿›ç¨‹<code>PCB</code>ï¼Œ<code>np</code>æ˜¯<code>fork</code>å‡ºæ¥çš„ï¼Œæ–°çš„è¿›ç¨‹çš„<code>PCB</code>ï¼Œè¯¥å‡½æ•°å°±æ˜¯åœ¨æ‰§è¡Œå¤åˆ¶è¿›ç¨‹çš„å·¥ä½œã€‚ä¸ºäº†è®©å­è¿›ç¨‹å¯ä»¥<code>trace</code>å’Œçˆ¶è¿›ç¨‹åŒæ ·çš„ç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦å°†çˆ¶è¿›ç¨‹çš„<code>trace_mask</code>ä¹Ÿå¤åˆ¶ä¸€ä¸‹ï¼Œæ·»åŠ ä¸€è¡Œä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Create a new process, copying the parent.
</span></span></span><span class=line><span class=cl><span class=c1>// Sets up child kernel stack to return as if from fork() system call.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=c1>// copy trace mask
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>trace_mask</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>trace_mask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>è‡³æ­¤å®Œæˆäº†æ·»åŠ å‡½æ•°è°ƒç”¨çš„ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥è¿˜éœ€è¦ç»™ç”¨æˆ·å¢åŠ æ¥å£ï¼Œæ•…åœ¨<code>usys.pl</code>ä¸­æœ«å°¾æ·»åŠ ä»£ç å¦‚ä¸‹(ä½œç”¨è§ <a class=link href=#%e7%94%a8%e6%88%b7%e6%80%81stub>ç”¨æˆ·æ€stub</a> é‚£ä¸€å°èŠ‚)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># added system call</span>
</span></span><span class=line><span class=cl><span class=n>entry</span><span class=p>(</span><span class=s>&#34;trace&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨å¤´æ–‡ä»¶<code>user/user.h</code>ä¸­æ·»åŠ è¯¥ç³»ç»Ÿè°ƒç”¨åŸå‹å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// added system call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>trace</span><span class=p>(</span><span class=kt>int</span> <span class=n>mask</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>ä¸€åˆ‡å®Œæˆåæµ‹è¯•èƒ½å¦é€šè¿‡æµ‹è¯•ï¼Œå¦‚ä¸‹</p><p><img src=/aniya_blog/p/lab2-system-calls/image-20230107224018542.png width=1094 height=172 srcset="/aniya_blog/p/lab2-system-calls/image-20230107224018542_hub6a9549b3f3d4c4fca4fe9bcf4cc5b3b_44222_480x0_resize_box_3.png 480w, /aniya_blog/p/lab2-system-calls/image-20230107224018542_hub6a9549b3f3d4c4fca4fe9bcf4cc5b3b_44222_1024x0_resize_box_3.png 1024w" loading=lazy alt=traceæµ‹è¯• class=gallery-image data-flex-grow=636 data-flex-basis=1526px></p><h3 id=sysinfo>sysinfo</h3><p>ç¬¬äºŒä¸ªæ·»åŠ çš„ç³»ç»Ÿè°ƒç”¨æ ¹æ®<a class=link href=https://pdos.csail.mit.edu/6.828/2020/labs/syscall.html target=_blank rel=noopener>å®éªŒæŒ‡å¯¼ä¹¦</a>æè¿°å¦‚ä¸‹</p><blockquote><p>In this assignment you will add a system call, <code>sysinfo</code>, that collects information about the running system. The system call takes one argument: a pointer to a <code>struct sysinfo</code> (see <code>kernel/sysinfo.h</code>). The kernel should fill out the fields of this struct: the <code>freemem</code> field should be set to the number of bytes of free memory, and the <code>nproc</code> field should be set to the number of processes whose <code>state</code> is not <code>UNUSED</code>. We provide a test program <code>sysinfotest</code>; you pass this assignment if it prints &ldquo;sysinfotest: OK&rdquo;.</p></blockquote><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>sysinfo</code>ç³»ç»Ÿè°ƒç”¨è¦æ±‚ç»™ç”¨æˆ·è¿”å›å¦‚ä¸‹ç»“æ„</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>sysinfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>freemem</span><span class=p>;</span>   <span class=c1>// amount of free memory (bytes)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>nproc</span><span class=p>;</span>     <span class=c1>// number of process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>æŒ‡å¯¼ä¹¦ä¸Šæ¯”è¾ƒå…³é”®çš„å‡ å¥æç¤ºå¦‚ä¸‹</p><ul><li>sysinfo needs to copy a <code>struct sysinfo</code> back to user space; see <code>sys_fstat()</code> (<code>kernel/sysfile.c</code>) and <code>filestat()</code> (<code>kernel/file.c</code>) for examples of how to do that using <code>copyout()</code>.</li><li>To collect the amount of free memory, add a function to <code>kernel/kalloc.c</code></li><li>To collect the number of processes, add a function to <code>kernel/proc.c</code></li></ul><p>å…¶ä¸­ç¬¬ä¸€ç‚¹åœ¨<a class=link href=%e7%94%a8%e6%88%b7%e6%80%81%e5%92%8c%e5%86%85%e6%a0%b8%e6%80%81%e6%95%b0%e6%8d%ae%e4%bc%a0%e8%be%93>å‰æ–‡</a>ä¸­æœ‰æ‰€æè¿°ã€‚</p><p>ä½†éå¸¸ç¾æ„§çš„æ˜¯ï¼Œç¬¬äºŒç¬¬ä¸‰ç‚¹ï¼Œé“ç†æˆ‘éƒ½æ‡‚ï¼Œå¯æ˜¯å…³äºxv6æˆ‘è¿˜ä¸€æ— æ‰€çŸ¥ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“æ€ä¹ˆè·å–ç³»ç»Ÿè¿›ç¨‹æ•°å’Œç©ºé—²å†…å­˜å‘€ğŸ˜…ï¼Œä¹Ÿæ²¡æœ‰ä¸€ç‚¹æç¤ºï¼Œè¿˜æ²¡çœ‹åˆ°xv6çš„å†…å­˜ç®¡ç†å’Œè¿›ç¨‹è°ƒåº¦å‘¢ğŸ¤¡</p><p>æ— å¥ˆç¨å¾®åœ¨ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹ğŸ™ƒï¼Œç¼–å†™è·å–ç©ºé—²å†…å­˜çš„ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// kalloc.c
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>run</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>spinlock</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>freelist</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>kmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// return number of free bytes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>uint64</span> <span class=nf>free_bytes</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>run</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>kmem</span><span class=p>.</span><span class=n>freelist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>num_of_free_page</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span><span class=p>(</span><span class=n>p</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>num_of_free_page</span> <span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>num_of_free_page</span> <span class=o>*</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢ä»£ç ä¸­çš„<code>kmem</code>ç”¨äºç®¡ç†å†…å­˜ï¼Œè¯¥ç»“æ„å†…æœ‰ä¸€ä¸ª<code>lock</code>å’Œ<code>freelist</code>ï¼Œé¡¾åæ€ä¹‰<code>freelist</code>åº”è¯¥å°±æ˜¯ä¸²èµ·ç©ºé—²é¡µçš„ç»“æ„(ç°å¸¸å¥‡æ€ªï¼Œè¿™ä¸ªé“¾è¡¨èŠ‚ç‚¹<code>struct run</code>ä¸ºæ¯›åªæœ‰ä¸€ä¸ªæŒ‡é’ˆ&mldr;)ï¼Œä½†æ€»ä¹‹å…ˆè¿™æ ·å§ï¼Œåé¢åšå†…å­˜ç®¡ç†æ—¶ä¼šçŸ¥é“æ€ä¹ˆå›äº‹çš„ğŸ¤£</p><p>ä¸Šé¢ä»£ç çš„<code>free_bytes</code>å³è·å–ç©ºé—²å†…å­˜å­—èŠ‚æ•°çš„å‡½æ•°ã€‚</p><hr><p>æ¥ä¸‹æ¥å†çœ‹çœ‹æ€ä¹ˆè·å–ç³»ç»Ÿè¿›ç¨‹æ•°ç›®ï¼Œä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>proc</span> <span class=n>proc</span><span class=p>[</span><span class=n>NPROC</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// get the number of process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>uint64</span> <span class=nf>num_proc</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>sum</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>NPROC</span><span class=p>;</span><span class=n>i</span> <span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>proc</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>state</span> <span class=o>!=</span> <span class=n>UNUSED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>sum</span> <span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢ä»£ç ä¸­çš„<code>proc</code>ç»“æ„ä½“å°±æ˜¯å­˜æ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€çš„ï¼Œ<code>struct proc</code>è¿™ä¸ªç»“æ„ä½“åœ¨å‰æ–‡ä¹Ÿçœ‹åˆ°è¿‡ï¼Œå†æ¬¡å±•ç¤ºå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>enum</span> <span class=n>procstate</span> <span class=p>{</span> <span class=n>UNUSED</span><span class=p>,</span> <span class=n>SLEEPING</span><span class=p>,</span> <span class=n>RUNNABLE</span><span class=p>,</span> <span class=n>RUNNING</span><span class=p>,</span> <span class=n>ZOMBIE</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Per-process state
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>spinlock</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// p-&gt;lock must be held when using these:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>enum</span> <span class=n>procstate</span> <span class=n>state</span><span class=p>;</span>        <span class=c1>// Process state
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>parent</span><span class=p>;</span>         <span class=c1>// Parent process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>chan</span><span class=p>;</span>                  <span class=c1>// If non-zero, sleeping on chan
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>killed</span><span class=p>;</span>                  <span class=c1>// If non-zero, have been killed
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>xstate</span><span class=p>;</span>                  <span class=c1>// Exit status to be returned to parent&#39;s wait
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>pid</span><span class=p>;</span>                     <span class=c1>// Process ID
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// these are private to the process, so p-&gt;lock need not be held.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>kstack</span><span class=p>;</span>               <span class=c1>// Virtual address of kernel stack
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>sz</span><span class=p>;</span>                   <span class=c1>// Size of process memory (bytes)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>;</span>       <span class=c1>// User page table
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>trapframe</span> <span class=o>*</span><span class=n>trapframe</span><span class=p>;</span> <span class=c1>// data page for trampoline.S
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>context</span> <span class=n>context</span><span class=p>;</span>      <span class=c1>// swtch() here to run process
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>file</span> <span class=o>*</span><span class=n>ofile</span><span class=p>[</span><span class=n>NOFILE</span><span class=p>];</span>  <span class=c1>// Open files
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>cwd</span><span class=p>;</span>           <span class=c1>// Current directory
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>name</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span>               <span class=c1>// Process name (debugging)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// for syscall trace
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>trace_mask</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­<code>state</code>ä¸ºè¿›ç¨‹çŠ¶æ€ï¼Œ<code>UNUSED</code>è¡¨ç¤º<code>proc</code>æ•°ç»„ä¸­è¯¥é¡¹è¿˜æœªè¢«ä½¿ç”¨ï¼Œæ•…è¦å¾—åˆ°è¿›ç¨‹æ•°ï¼Œåªéœ€è¦éå†<code>proc</code>æ•°ç»„ï¼Œçœ‹çœ‹ä¸æ˜¯<code>UNUSED</code>çš„æœ‰å¤šå°‘ä¸ªå³å¯ï¼Œå…·ä½“ä»£ç è§ä¸Šé¢çš„<code>num_proc</code>.</p><p>å†™äº†<code>num_proc</code>å’Œ<code>free_bytes</code>è¿™ä¿©å‡½æ•°åï¼Œæ¥ç€å°±å¾ˆå®¹æ˜“ç¼–å†™æˆ‘ä»¬çš„ç³»ç»Ÿè°ƒç”¨äº†ï¼Œåœ¨<code>kernel/sysproc.c</code>æ·»åŠ å¦‚ä¸‹ç³»ç»Ÿè°ƒç”¨ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>sys_sysinfo</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>info</span><span class=p>;</span>  <span class=c1>// user pointer to struct sysinfo
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>sysinfo</span> <span class=n>si</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=nf>num_proc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=nf>free_bytes</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>si</span><span class=p>.</span><span class=n>freemem</span> <span class=o>=</span> <span class=nf>free_bytes</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>si</span><span class=p>.</span><span class=n>nproc</span> <span class=o>=</span> <span class=nf>num_proc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>argaddr</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=o>&amp;</span><span class=n>info</span><span class=p>);</span> <span class=c1>// get user&#39;s pointer to struct sysinfo
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>copyout</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=n>info</span><span class=p>,(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>si</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>si</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// use copyout to copy si to user address space
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä»–æ“ä½œåœ¨æ­¤ç•¥è¿‡ï¼Œè¯¦è§ä¸Šä¸€å°èŠ‚ï¼ˆå¦‚æ·»åŠ ç³»ç»Ÿè°ƒç”¨å·ï¼Œä¿®æ”¹<code>syscall.c</code>ç­‰ç­‰ï¼‰.</p><hr><h2 id=å°¾å£°>å°¾å£°</h2><p>è¿™ä¸ªç³»åˆ—å¯è°“æ˜¯å†™ä¸€ç¯‡å°‘ä¸€ç¯‡å•¦ğŸ˜†</p><p>å¯æŒ‡ä¸å‡†å•¥æ—¶å€™å°±â€œä¸­é“å´©æ®‚â€äº†ï¼Œä¸è¿‡ä¸ç®¡æ€ä¹ˆè¯´ï¼Œå‰ä¸¤ä¸ªå®éªŒåšå®Œå•¦ï¼</p><p>è¿™ä¸¤ä¸ªå®éªŒéƒ½åªæ˜¯æ‘¸æ‘¸xv6çš„è¡¨é¢ï¼Œä¸‹ä¸€ä¸ªå®éªŒç»ˆäºæ­£å¼å’Œæ“ä½œç³»ç»Ÿç›¸å…³å•¦ï¼è¿›å…¥å†…å­˜ç®¡ç†é˜¶æ®µï¼ï¼</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/aniya_blog/p/os_util_lab/><div class=article-image><img src=/aniya_blog/p/os_util_lab/saber2.d3cf7db7f3e39c28f3c1c04197864dea_hu583263cbbee05d2c263b501713a891d4_83776_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post OS_util_lab" data-hash="md5-0899t/PjnCjzwcBBl4ZN6g=="></div><div class=article-details><h2 class=article-title>OS_util_lab</h2></div></a></article><article class=has-image><a href=/aniya_blog/p/xv6-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/><div class=article-image><img src=/aniya_blog/p/xv6-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/wallpaper.74540f2c69533900a024c238ae79d45e_hu0ff37ebbb98d2b42bafbb67ed8d5243a_153541_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post xv6 ç¯å¢ƒé…ç½®" data-hash="md5-dFQPLGlTOQCgJMI4rnnUXg=="></div><div class=article-details><h2 class=article-title>xv6 ç¯å¢ƒé…ç½®</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Aniya's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/aniya_blog/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>