<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='MIT 6.S081 ç¬¬ä¸‰ä¸ªå®éªŒï¼Œpagetable labçš„åšæ³•è®°å½•'><title>MIT 6.S081 pagetable lab</title>
<link rel=canonical href=https://XieWeikai.github.io/aniya_blog/p/mit-6.s081-pagetable-lab/><link rel=stylesheet href=/aniya_blog/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css><meta property='og:title' content='MIT 6.S081 pagetable lab'><meta property='og:description' content='MIT 6.S081 ç¬¬ä¸‰ä¸ªå®éªŒï¼Œpagetable labçš„åšæ³•è®°å½•'><meta property='og:url' content='https://XieWeikai.github.io/aniya_blog/p/mit-6.s081-pagetable-lab/'><meta property='og:site_name' content="Aniya's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-01-19T18:27:13+08:00'><meta property='article:modified_time' content='2023-01-19T18:27:13+08:00'><meta property='og:image' content='https://XieWeikai.github.io/aniya_blog/p/mit-6.s081-pagetable-lab/wallpaper.jpg'><meta name=twitter:title content="MIT 6.S081 pagetable lab"><meta name=twitter:description content="MIT 6.S081 ç¬¬ä¸‰ä¸ªå®éªŒï¼Œpagetable labçš„åšæ³•è®°å½•"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://XieWeikai.github.io/aniya_blog/p/mit-6.s081-pagetable-lab/wallpaper.jpg'><link rel="shortcut icon" href=/aniya_blog/aniya.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/aniya_blog/><img src=/aniya_blog/img/aniya_hu746a8935f3131bdc51d8425bcf15aebb_113600_300x0_resize_q75_box.jpeg width=300 height=188 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¤¤</span></figure><div class=site-meta><h1 class=site-name><a href=/aniya_blog>Aniya's Blog</a></h1><h2 class=site-description>Just for fun.</h2></div></header><ol class=social-menu><li><a href=https://github.com/XieWeikai target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/aniya_blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/aniya_blog/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/aniya_blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/aniya_blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/aniya_blog/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://XieWeikai.github.io/aniya_blog/ selected>ä¸­æ–‡</option><option value=https://XieWeikai.github.io/aniya_blog/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#print-a-page-table>Print a page table</a><ol><li><a href=#é¢˜ç›®æè¿°>é¢˜ç›®æè¿°</a></li><li><a href=#åšæ³•>åšæ³•</a></li></ol></li><li><a href=#a-kernel-page-table-per-process>A kernel page table per process</a><ol><li><a href=#é¢˜ç›®æè¿°-1>é¢˜ç›®æè¿°</a></li><li><a href=#åšæ³•-1>åšæ³•</a></li></ol></li><li><a href=#simplify-copyincopyinstr>Simplify <code>copyin/copyinstr</code></a><ol><li><a href=#é—®é¢˜æè¿°>é—®é¢˜æè¿°</a></li><li><a href=#åšæ³•-2>åšæ³•</a><ol><li><a href=#è¾…åŠ©å‡½æ•°>è¾…åŠ©å‡½æ•°</a></li><li><a href=#userinit>userinit</a></li><li><a href=#fork>fork</a></li><li><a href=#exec>exec</a></li><li><a href=#sbrk>sbrk</a></li><li><a href=#copyincopyinstr><code>copyin/copyinstr</code></a></li></ol></li></ol></li><li><a href=#å°¾å£°>å°¾å£°</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/aniya_blog/p/mit-6.s081-pagetable-lab/><img src=/aniya_blog/p/mit-6.s081-pagetable-lab/wallpaper_huab5b610965824e9998b331044434bd2e_2713187_800x0_resize_q75_box.jpg srcset="/aniya_blog/p/mit-6.s081-pagetable-lab/wallpaper_huab5b610965824e9998b331044434bd2e_2713187_800x0_resize_q75_box.jpg 800w, /aniya_blog/p/mit-6.s081-pagetable-lab/wallpaper_huab5b610965824e9998b331044434bd2e_2713187_1600x0_resize_q75_box.jpg 1600w" width=800 height=533 loading=lazy alt="Featured image of post MIT 6.S081 pagetable lab"></a></div><div class=article-details><header class=article-category><a href=/aniya_blog/categories/os/ style=background-color:#2a9d8f;color:#fff>OS</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/aniya_blog/p/mit-6.s081-pagetable-lab/>MIT 6.S081 pagetable lab</a></h2><h3 class=article-subtitle>MIT 6.S081 ç¬¬ä¸‰ä¸ªå®éªŒï¼Œpagetable labçš„åšæ³•è®°å½•</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jan 19, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 17 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=lab-page-tables>Lab: page tables</h1><p>è·ç¦»ä¸Šä¸€æ¬¡å®éªŒçš„æ–‡ç« å‘è¡¨å·²ç»è¿‡å»äº†æ•´æ•´13å¤©ï¼Œå¿«ä¸¤å‘¨äº†ğŸ˜€ï¼Œç»ˆäºåœ¨å‰å‡ å¤©åšå®Œäº†ç¬¬ä¸‰ä¸ªå®éªŒã€‚é‰´äº<a class=link href=../mit-6.s081-page-table-%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90>å‰ä¸€ç¯‡æ–‡ç« </a>å†™çš„å¤ªé•¿äº†ï¼Œå·²ç»å¯¹ç›¸å…³çš„æˆ‘çœ‹è¿‡çš„ä»£ç è¿›è¡Œäº†*ï¼ˆæ·±å…¥çš„ï¼‰*è§£æ&mldr;ğŸ˜¤ï¼Œæ•…è¿™ç¯‡æ–‡ç« ç®€å•ç½—åˆ—ä¸€ä¸‹æˆ‘çš„åšæ³•å°±è±¡å¾æ€§çš„ç»“æŸå•¦ã€‚</p><p>è¿™ä¸ªå®éªŒçš„å®˜æ–¹é¡µé¢ç½‘å€ä¸º: <a class=link href=https://pdos.csail.mit.edu/6.828/2020/labs/pgtbl.html target=_blank rel=noopener>https://pdos.csail.mit.edu/6.828/2020/labs/pgtbl.html</a></p><h2 id=print-a-page-table>Print a page table</h2><h3 id=é¢˜ç›®æè¿°>é¢˜ç›®æè¿°</h3><blockquote><p>Define a function called <code>vmprint()</code>. It should take a <code>pagetable_t</code> argument, and print that pagetable in the format described below. Insert <code>if(p->pid==1) vmprint(p->pagetable)</code> in exec.c just before the <code>return argc</code>, to print the first process&rsquo;s page table. You receive full credit for this assignment if you pass the <code>pte printout</code> test of <code>make grade</code>.</p></blockquote><blockquote><p>Now when you start xv6 it should print output like this, describing the page table of the first process at the point when it has just finished <code>exec()</code>ing <code>init</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>page table 0x0000000087f6e000
</span></span><span class=line><span class=cl>..0: pte 0x0000000021fda801 pa 0x0000000087f6a000
</span></span><span class=line><span class=cl>.. ..0: pte 0x0000000021fda401 pa 0x0000000087f69000
</span></span><span class=line><span class=cl>.. .. ..0: pte 0x0000000021fdac1f pa 0x0000000087f6b000
</span></span><span class=line><span class=cl>.. .. ..1: pte 0x0000000021fda00f pa 0x0000000087f68000
</span></span><span class=line><span class=cl>.. .. ..2: pte 0x0000000021fd9c1f pa 0x0000000087f67000
</span></span><span class=line><span class=cl>..255: pte 0x0000000021fdb401 pa 0x0000000087f6d000
</span></span><span class=line><span class=cl>.. ..511: pte 0x0000000021fdb001 pa 0x0000000087f6c000
</span></span><span class=line><span class=cl>.. .. ..510: pte 0x0000000021fdd807 pa 0x0000000087f76000
</span></span><span class=line><span class=cl>.. .. ..511: pte 0x0000000020001c0b pa 0x0000000080007000
</span></span></code></pre></td></tr></table></div></div></blockquote><blockquote><p>The first line displays the argument to <code>vmprint</code>. After that there is a line for each PTE, including PTEs that refer to page-table pages deeper in the tree. Each PTE line is indented by a number of <code>" .."</code> that indicates its depth in the tree. Each PTE line shows the PTE index in its page-table page, the pte bits, and the physical address extracted from the PTE. Don&rsquo;t print PTEs that are not valid. In the above example, the top-level page-table page has mappings for entries 0 and 255. The next level down for entry 0 has only index 0 mapped, and the bottom-level for that index 0 has entries 0, 1, and 2 mapped.</p></blockquote><h3 id=åšæ³•>åšæ³•</h3><p>åœ¨å®˜ç½‘ä¸Šç»™å‡ºçš„æç¤ºç²˜è´´å¦‚ä¸‹</p><blockquote><p>Some hints:</p><ul><li>You can put <code>vmprint()</code> in <code>kernel/vm.c</code>.</li><li>Use the macros at the end of the file kernel/riscv.h.</li><li>The function <code>freewalk</code> may be inspirational.</li><li>Define the prototype for <code>vmprint</code> in kernel/defs.h so that you can call it from exec.c.</li><li>Use <code>%p</code> in your printf calls to print out full 64-bit hex PTEs and addresses as shown in the example.</li></ul></blockquote><p>è¿™ä¸ªé¢˜ï¼Œæ— éç”¨é€’å½’çš„æ–¹å¼æ‰“å°æ¯ä¸€çº§é¡µè¡¨å°±å®Œäº‹äº†ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šå®ç°ä»£ç ï¼Œåœ¨<code>vm.c</code>ä¸­<code>vmprint</code>å‡½æ•°å®ç°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>* a helper function to print page table recursively
</span></span></span><span class=line><span class=cl><span class=cm>* level is the level of pagetable
</span></span></span><span class=line><span class=cl><span class=cm>* 0 is the highest level
</span></span></span><span class=line><span class=cl><span class=cm>* 2 is the lowest level
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>print_pte</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pt</span><span class=p>,</span><span class=kt>int</span> <span class=n>level</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>level</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span> <span class=o>=</span> <span class=p>(</span><span class=kt>pte_t</span> <span class=o>*</span><span class=p>)</span><span class=n>pt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span><span class=p>(</span><span class=n>pte</span> <span class=o>-</span> <span class=p>(</span><span class=kt>pte_t</span> <span class=o>*</span><span class=p>)</span><span class=n>pt</span> <span class=o>&lt;</span> <span class=mi>512</span><span class=p>){</span> <span class=c1>// 512 pte in a page
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_V</span><span class=p>){</span> <span class=c1>// available entry
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>level</span><span class=p>;</span><span class=n>i</span> <span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;.. &#34;</span><span class=p>);</span>  <span class=c1>// indent
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;..%d: pte %p pa %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>pte</span> <span class=o>-</span> <span class=p>(</span><span class=kt>pte_t</span><span class=o>*</span><span class=p>)</span><span class=n>pt</span><span class=p>,</span><span class=o>*</span><span class=n>pte</span><span class=p>,</span><span class=nf>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=nf>print_pte</span><span class=p>((</span><span class=kt>pagetable_t</span><span class=p>)</span><span class=nf>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>),</span><span class=n>level</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>pte</span> <span class=o>++</span><span class=p>;</span> <span class=c1>// next pte
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>* print the content of a pagetable
</span></span></span><span class=line><span class=cl><span class=cm>* this is a task for pagetable lab
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>vmprint</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pt</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;page table %p</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>pt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>print_pte</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å®ç°å®Œè¯¥å‡½æ•°åï¼Œåœ¨<code>exec</code>æœ€åï¼Œå½“è¿›ç¨‹<code>pid</code>ä¸º1åˆ™æ‰“å°é‚£ä¸ªè¿›ç¨‹çš„<code>pagetable</code>ï¼Œåœ¨<code>exec</code>å‡½æ•°æ·»åŠ ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>exec</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span> <span class=nf>vmprint</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>);</span> <span class=c1>// this line is for pagetable lab
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>argc</span><span class=p>;</span> <span class=c1>// this ends up in a0, the first argument to main(argc, argv)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è‡³æ­¤ç¬¬ä¸€ä¸ªtaskåœ†æ»¡å®Œæˆã€‚</p><hr><h2 id=a-kernel-page-table-per-process>A kernel page table per process</h2><h3 id=é¢˜ç›®æè¿°-1>é¢˜ç›®æè¿°</h3><p>åœ¨xv6åŸæ¥çš„ä»£ç å®ç°ä¸­ï¼Œå†…æ ¸å°±ä½¿ç”¨å›ºå®šçš„ä¸€ä¸ª<code>page table</code>ï¼Œå³<a class=link href=../mit-6.s081-page-table-%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90/#%e5%86%85%e6%a0%b8%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e5%88%9d%e5%a7%8b%e5%8c%96>ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­è®²åˆ°çš„<code>kernel_pagetable</code>ï¼Œåœ¨è¿™ä¸ªtaskä¸­éœ€è¦ç»™æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„<code>kernel page table</code>ï¼Œè¿™äº›<code>page table</code>ä¸­çš„å¤§éƒ¨åˆ†æ˜ å°„å‡å’Œ<code>kernel_pagetable</code>ä¸€è‡´ï¼Œé¢˜ç›®æè¿°æ‘˜æŠ„å¦‚ä¸‹</p><blockquote><p>Your first job is to modify the kernel so that every process uses its own copy of the kernel page table when executing in the kernel. Modify <code>struct proc</code> to maintain a kernel page table for each process, and modify the scheduler to switch kernel page tables when switching processes. For this step, each per-process kernel page table should be identical to the existing global kernel page table. You pass this part of the lab if <code>usertests</code> runs correctly.</p></blockquote><h3 id=åšæ³•-1>åšæ³•</h3><p>è¯¥taskç»™äº†ä¸€äº›æç¤ºï¼Œå¦‚ä¸‹</p><blockquote><p>Some hints:</p><ul><li>Add a field to <code>struct proc</code> for the process&rsquo;s kernel page table.</li><li>A reasonable way to produce a kernel page table for a new process is to implement a modified version of <code>kvminit</code> that makes a new page table instead of modifying <code>kernel_pagetable</code>. You&rsquo;ll want to call this function from <code>allocproc</code>.</li><li>Make sure that each process&rsquo;s kernel page table has a mapping for that process&rsquo;s kernel stack. In unmodified xv6, all the kernel stacks are set up in <code>procinit</code>. You will need to move some or all of this functionality to <code>allocproc</code>.</li><li>Modify <code>scheduler()</code> to load the process&rsquo;s kernel page table into the core&rsquo;s <code>satp</code> register (see <code>kvminithart</code> for inspiration). Don&rsquo;t forget to call <code>sfence_vma()</code> after calling <code>w_satp()</code>.</li><li><code>scheduler()</code> should use <code>kernel_pagetable</code> when no process is running.</li><li>Free a process&rsquo;s kernel page table in <code>freeproc</code>.</li><li>You&rsquo;ll need a way to free a page table without also freeing the leaf physical memory pages.</li><li><code>vmprint</code> may come in handy to debug page tables.</li><li>It&rsquo;s OK to modify xv6 functions or add new functions; you&rsquo;ll probably need to do this in at least <code>kernel/vm.c</code> and <code>kernel/proc.c</code>. (But, don&rsquo;t modify <code>kernel/vmcopyin.c</code>, <code>kernel/stats.c</code>, <code>user/usertests.c</code>, and <code>user/stats.c</code>.)</li><li>A missing page table mapping will likely cause the kernel to encounter a page fault. It will print an error that includes <code>sepc=0x00000000XXXXXXXX</code>. You can find out where the fault occurred by searching for <code>XXXXXXXX</code> in <code>kernel/kernel.asm</code>.</li></ul></blockquote><p>è¦å®Œæˆè¿™ä¸ªä»»åŠ¡å°±è·Ÿç€æç¤ºä¸€æ­¥æ­¥åšåŸºæœ¬å°±è¡Œã€‚</p><p>é¦–å…ˆåœ¨è¿›ç¨‹ç»“æ„ä¸­æ·»åŠ ä¸€é¡¹å†…æ ¸é¡µè¡¨é¡¹ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Per-process state
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>proc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=c1>// per-process page table
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>pagetable_t</span> <span class=n>kernel_pgtb</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>ç”±äºæ¯ä¸ªè¿›ç¨‹éƒ½è¦åˆ›å»ºä¸€ä¸ªå†…æ ¸é¡µè¡¨ï¼Œæ•…æ¨¡ä»¿<code>kvminit</code>å‡½æ•°å†™ä¸€ä¸ªåˆ›å»ºå†…æ ¸é¡µè¡¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>* this is a helper function that maps pages.
</span></span></span><span class=line><span class=cl><span class=cm>* a helper function for make_kernel_ptbl
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>map_helper</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pt</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>va</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>pa</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>sz</span><span class=p>,</span> <span class=kt>int</span> <span class=n>perm</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>mappages</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span> <span class=n>va</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>pa</span><span class=p>,</span> <span class=n>perm</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;map_helper&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>* make a page table that is identical to kernel_pagetable
</span></span></span><span class=line><span class=cl><span class=cm>* this function is used for make a copy of kernel page table
</span></span></span><span class=line><span class=cl><span class=cm>* for each process.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kt>pagetable_t</span> <span class=nf>make_kernel_ptbl</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=kt>pagetable_t</span> <span class=n>pt</span> <span class=o>=</span> <span class=p>(</span><span class=kt>pagetable_t</span><span class=p>)</span> <span class=nf>kalloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// uart registers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>UART0</span><span class=p>,</span> <span class=n>UART0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// virtio mmio disk interface
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>VIRTIO0</span><span class=p>,</span> <span class=n>VIRTIO0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// CLINT
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>CLINT</span><span class=p>,</span> <span class=n>CLINT</span><span class=p>,</span> <span class=mh>0x10000</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// PLIC
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>PLIC</span><span class=p>,</span> <span class=n>PLIC</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// map kernel text executable and read-only.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>KERNBASE</span><span class=p>,</span> <span class=n>KERNBASE</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=o>-</span><span class=n>KERNBASE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_X</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// map kernel data and the physical RAM we&#39;ll make use of.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span> <span class=n>PHYSTOP</span><span class=o>-</span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// map the trampoline for trap entry/exit to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the highest virtual address in the kernel.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>TRAMPOLINE</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>trampoline</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_X</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯¥å‡½æ•°åŸºæœ¬å°±æ˜¯é˜²ç€<code>kvminit</code>ï¼Œæ„é€ äº†ä¸€ä»½å’Œ<code>kernel_pagetable</code>ä¸€æ ·çš„å†…æ ¸é¡µè¡¨.</p><p>æ¥ç€éœ€è¦åœ¨æ‰€æœ‰åˆ›å»ºè¿›ç¨‹çš„åœ°æ–¹åˆ›å»ºä¸€ä»½å†…æ ¸é¡µè¡¨å­˜å…¥å¯¹åº”çš„<code>struct proc</code>ç»“æ„ä¸­ï¼Œä¸Š<a class=link href=../mit-6.s081-page-table-%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90/#%e5%88%9b%e5%bb%ba%e8%bf%9b%e7%a8%8b>ä¸€ç¯‡æ–‡ç« </a>æåˆ°ï¼Œç±»UNIXç³»ç»Ÿä¸­æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯é€šè¿‡<code>fork()</code>åˆ›å»ºå‡ºæ¥çš„ï¼ˆç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯ä¾‹å¤–ï¼Œå› ä¸ºæ­¤æ—¶è¿˜æ²¡æœ‰è¿›ç¨‹å¯ä»¥è¿›è¡Œ<code>fork</code>æ“ä½œï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªè¿›ç¨‹åœ¨<code>userinit</code>ç”±ç³»ç»Ÿæ„é€ ï¼‰ï¼Œè€Œ<code>fork</code>ç”¨åˆ°äº†<code>allocproc</code>å‡½æ•°åˆ†é…ä¸€ä¸ª<code>UNUSED</code>çš„<code>struct proc</code>å¹¶è¿›è¡Œäº†ä¸€äº›åˆå§‹åŒ–ï¼Œæ•…åœ¨<code>allocproc</code>å‡½æ•°ä¸­æ·»åŠ åˆ›å»ºå†…æ ¸é¡µè¡¨ç›¸å…³ä»£ç ï¼Œä¿®æ”¹å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Look in the process table for an UNUSED proc.
</span></span></span><span class=line><span class=cl><span class=c1>// If found, initialize state required to run in the kernel,
</span></span></span><span class=line><span class=cl><span class=c1>// and return with p-&gt;lock held.
</span></span></span><span class=line><span class=cl><span class=c1>// If there are no free procs, or a memory allocation fails, return 0.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>proc</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>allocproc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>proc</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>proc</span><span class=p>[</span><span class=n>NPROC</span><span class=p>];</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>acquire</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>==</span> <span class=n>UNUSED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>found</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>found</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span> <span class=o>=</span> <span class=nf>allocpid</span><span class=p>();</span>  <span class=c1>// next pid not been used
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// Allocate a trapframe page.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>((</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>trapframe</span> <span class=o>*</span><span class=p>)</span><span class=nf>kalloc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span> <span class=c1>// in kernel space, kalloc returns a physical address. so p-&gt;trapframe is a physical address
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// An empty user page table.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span> <span class=o>=</span> <span class=nf>proc_pagetable</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// this return a page table that has trampoline and trapframe pages mapped
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>freeproc</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// æ­¤å¤„æ·»åŠ ä¸€å¥åˆ›å»ºå†…æ ¸é¡µè¡¨çš„ä»£ç 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span> <span class=o>=</span> <span class=nf>make_kernel_ptbl</span><span class=p>();</span> <span class=c1>// a kernel page table per process
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ ¹æ®æç¤ºï¼ŒåŸå…ˆçš„å®ç°ä¸­ï¼Œæ‰€æœ‰çš„<code>kernel_stack</code>å‡åœ¨<code>procinit</code>ä¸­ç»™æ‰€æœ‰è¿›ç¨‹åˆ†é…å¥½äº†ï¼Œç›¸å…³æ˜ å°„å…¨éƒ½æ”¾åœ¨äº†å…¨å±€çš„é‚£ä¸ª<code>kernel_pagetable</code>ä¸­ï¼Œä½œä¸ºæ”¹è¿›ï¼Œåº”è¯¥å°†åˆ†é…å†…æ ¸æ ˆè¿™ä¸€æ­¥éª¤ä»<code>procinit</code>ç§»å‡ºæ¥ï¼Œæ”¾å…¥<code>allocproc</code>ä¸­ï¼Œå†…æ ¸æ ˆçš„æ˜ å°„åº”æ”¾åˆ°æ¯ä¸ªè¿›ç¨‹è‡ªå·±çš„å†…æ ¸é¡µè¡¨ä¸­ï¼Œè€Œä¸æ˜¯å…¨å±€çš„å†…æ ¸é¡µè¡¨<code>kernel_pagetable</code>ã€‚</p><p>é¦–å…ˆä¿®æ”¹<code>procinit</code>ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// initialize the proc table at boot time.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>procinit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nf>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pid_lock</span><span class=p>,</span> <span class=s>&#34;nextpid&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>proc</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=o>&amp;</span><span class=n>proc</span><span class=p>[</span><span class=n>NPROC</span><span class=p>];</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>initlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>,</span> <span class=s>&#34;proc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// // Allocate a page for the process&#39;s kernel stack.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// // Map it high in memory, followed by an invalid
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// // guard page.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// char *pa = kalloc();
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// if(pa == 0)
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//   panic(&#34;kalloc&#34;);
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// uint64 va = KSTACK((int) (p - proc));
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W);
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// p-&gt;kstack = va;
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// above code set up kernel stack
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// in the lab: page table per process, we move this part to allocproc()
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>kvminithart</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å°†<code>kstack</code>ç›¸å…³ä»£ç å…¨éƒ¨æ³¨é‡Šæ‰ï¼Œæ¥ç€åœ¨<code>allocproc</code>ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Look in the process table for an UNUSED proc.
</span></span></span><span class=line><span class=cl><span class=c1>// If found, initialize state required to run in the kernel,
</span></span></span><span class=line><span class=cl><span class=c1>// and return with p-&gt;lock held.
</span></span></span><span class=line><span class=cl><span class=c1>// If there are no free procs, or a memory allocation fails, return 0.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=n>proc</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>allocproc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span> <span class=o>=</span> <span class=nf>make_kernel_ptbl</span><span class=p>();</span> <span class=c1>// a kernel page table per process
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// set up kstack
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>pa</span> <span class=o>=</span> <span class=nf>kalloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>pa</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;kalloc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ä¸€ä¸‹ä»£ç ç»™è¿›ç¨‹åˆ†é…å†…æ ¸æ ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>va</span> <span class=o>=</span> <span class=nf>KSTACK</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>p</span> <span class=o>-</span> <span class=n>proc</span><span class=p>));</span> 
</span></span><span class=line><span class=cl>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>va</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>pa</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>kstack</span> <span class=o>=</span> <span class=n>va</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è‡³æ­¤<code>allocproc</code>ä¿®æ”¹å®Œæ¯•ã€‚</p><hr><p>æŒ‰ç…§æç¤ºï¼Œæ¥ç€å°±åº”è¯¥ä¿®æ”¹è°ƒåº¦å™¨<code>scheduler</code>äº†ï¼Œåœ¨å°†<code>cpu</code>è½¬äº¤ç»™ç”¨æˆ·è¿›ç¨‹å‰å…ˆå°†<code>satp</code>æ”¹ä¸ºå¯¹åº”çš„ç”¨æˆ·å†…æ ¸é¡µè¡¨ï¼Œæ²¡æœ‰è¿›ç¨‹è¿è¡Œæ—¶æ”¹å›<code>kernel_pagetable</code>ï¼Œä¿®æ”¹<code>scheduler</code>å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Per-CPU process scheduler.
</span></span></span><span class=line><span class=cl><span class=c1>// Each CPU calls scheduler() after setting itself up.
</span></span></span><span class=line><span class=cl><span class=c1>// Scheduler never returns.  It loops, doing:
</span></span></span><span class=line><span class=cl><span class=c1>//  - choose a process to run.
</span></span></span><span class=line><span class=cl><span class=c1>//  - swtch to start running that process.
</span></span></span><span class=line><span class=cl><span class=c1>//  - eventually that process transfers control
</span></span></span><span class=line><span class=cl><span class=c1>//    via swtch back to the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>scheduler</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl> 	<span class=c1>// load process&#39;s kernel page table
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// so that when a process trap in the kernel, the loaded page table here
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// will be used (I guess... I haven&#39;t read the code about how process trap in kernel and I don&#39;t know how to return to process from kernel)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>w_satp</span><span class=p>(</span><span class=nf>MAKE_SATP</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nf>sfence_vma</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>swtch</span><span class=p>(</span><span class=o>&amp;</span><span class=n>c</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// back to kernel, should use kernel_pagetable
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>kvminithart</span><span class=p>();</span> 
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚ä¸Šï¼Œåœ¨<code>swtch</code>å‰åæ·»åŠ ä»£ç ã€‚</p><hr><p>æ¥ç€ç…§ç€æç¤ºï¼Œåœ¨é‡Šæ”¾ä¸€ä¸ªè¿›ç¨‹çš„èµ„æºæ—¶åº”å½“æŠŠå¯¹åº”å†…æ ¸é¡µè¡¨å ç”¨çš„èµ„æºä¹Ÿé‡Šæ”¾æ‰ï¼Œé‡Šæ”¾è¿›ç¨‹èµ„æºä»£ç è§<code>freeprocess</code>ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// free a proc structure and the data hanging from it,
</span></span></span><span class=line><span class=cl><span class=c1>// including user pages.
</span></span></span><span class=line><span class=cl><span class=c1>// p-&gt;lock must be held.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>freeproc</span><span class=p>(</span><span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>proc_freepagetable</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>parent</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>chan</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>killed</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>xstate</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>UNUSED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ·»åŠ ä¸€ä¸ªé‡Šæ”¾å†…æ ¸é¡µè¡¨å æ®ç©ºé—´çš„å‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>proc_freekernel_pgtb</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span><span class=kt>int</span> <span class=n>level</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>level</span> <span class=o>&gt;</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// there are 2^9 = 512 PTEs in a page table.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>512</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>pte_t</span> <span class=n>pte</span> <span class=o>=</span> <span class=n>pagetable</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_V</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=c1>// this PTE points to a lower-level page table.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>uint64</span> <span class=n>child</span> <span class=o>=</span> <span class=nf>PTE2PA</span><span class=p>(</span><span class=n>pte</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>proc_freekernel_pgtb</span><span class=p>((</span><span class=kt>pagetable_t</span><span class=p>)</span><span class=n>child</span><span class=p>,</span><span class=n>level</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>pagetable</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>pagetable</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¯¥å‡½æ•°é€’å½’çš„é‡Šæ”¾é¡µè¡¨æ‰€åœ¨é¡µï¼Œå°†å…¶æ”¾å›<code>freelist</code>ä¸­ï¼Œä½†æ³¨æ„è¯¥å‡½æ•°åªé‡Šæ”¾é¡µè¡¨å æ®çš„ç©ºé—´ï¼Œè€Œä¸ä¼šé‡Šæ”¾é¡µè¡¨æ˜ å°„åˆ°çš„ç‰©ç†å†…å­˜ã€‚<em>å¦‚æœé‡Šæ”¾äº†å¯¹åº”ç‰©ç†å†…å­˜ï¼Œé‚£ç›´æ¥å¯„äº†ï¼Œæ˜ å°„åˆ°çš„æ‰€æœ‰ç‰©ç†é¡µéƒ½ä¼šæ”¾ä¸€ä¸ª<code>struct run</code>ç»“æ„ï¼Œç ´åäº†åŸæœ‰æ•°æ®ï¼Œä¸”æ‰€æœ‰è¿™äº›åœ°å€éƒ½å¯èƒ½ä¼šè¢«<code>kalloc</code>åˆ†é…åœ¨åˆ«çš„åœ°æ–¹ä½¿ç”¨ï¼Œè¿™äº›åœ°å€éƒ½æ”¾ç€ä¸åº”è¯¥åŠ¨çš„æ•°æ®æˆ–è€…å…¶ä»–IOè®¾å¤‡</em>ã€‚</p><p>æ¥ç€ä¿®æ”¹<code>freeproc</code>å‡½æ•°å¦‚ä¸‹ï¼Œæœ€åˆæˆ‘ä¿®æ”¹çš„ç‰ˆæœ¬å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// free a proc structure and the data hanging from it,
</span></span></span><span class=line><span class=cl><span class=c1>// including user pages.
</span></span></span><span class=line><span class=cl><span class=c1>// p-&gt;lock must be held.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>freeproc</span><span class=p>(</span><span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>proc_freepagetable</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>)</span> <span class=c1>// æ·»åŠ çš„ä»£ç 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>proc_freekernel_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä½†è¿™æ ·ä¿®æ”¹æœ‰ä¸€äº›æµ‹è¯•æ— æ³•é€šè¿‡&mldr;&mldr;åæ¥æˆ‘åœ¨<code>sys_exec</code>ä¸­æ‰“å°ç©ºé—²ç‰©ç†é¡µæ•°ç›®æ—¶å‘ç°ï¼Œæˆ‘æ¯æ‰§è¡Œå®Œä¸€ä¸ªè¿›ç¨‹ï¼Œç©ºé—²ç‰©ç†é¡µå°±å°‘ä¸€é¡µï¼Œè¯´æ˜è¿˜å°‘é‡Šæ”¾äº†äº›ä»€ä¹ˆä¸œè¥¿ğŸ˜¨ï¼Œå›å¤´çœ‹<code>allocproc</code>æ—¶ï¼Œè®°èµ·æ¥æˆ‘ä¸ä»…åˆ›å»ºäº†å†…æ ¸é¡µè¡¨ï¼ŒåŒæ—¶åˆ†é…äº†ä¸€é¡µç©ºé—²å†…å­˜ä½œä¸º<code>kstack</code>ï¼Œè€Œè¿™ä¸€é¡µåœ¨é‡Šæ”¾èµ„æºæ—¶å¿˜è®°å›æ”¶äº†ğŸ˜‡</p><p>æœ€ç»ˆç‰ˆ<code>freeproc</code>å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// free a proc structure and the data hanging from it,
</span></span></span><span class=line><span class=cl><span class=c1>// including user pages.
</span></span></span><span class=line><span class=cl><span class=c1>// p-&gt;lock must be held.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>freeproc</span><span class=p>(</span><span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl>  <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kstack</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span> <span class=c1>// ç”¨uvmunmapåˆ é™¤kstackçš„æ˜ å°„ï¼Œdo_freeå‚æ•°ä¸º1ï¼ŒåŒæ—¶é‡Šæ”¾å¯¹åº”ç‰©ç†é¡µ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>proc_freekernel_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>æœ€åè¿˜æœ‰ä¸€ä¸ªé¬¼åœ°æ–¹å®˜æ–¹æç¤ºæ²¡æœ‰æåˆ°çš„ï¼Œåšäº†ä»¥ä¸Šçš„ä¿®æ”¹åä¼šæŠ¥ä¸€ä¸ª<code>panic: kvmpa</code>ï¼Œéœ€è¦ä¿®æ”¹<code>kvmpa</code>å‡½æ•°ï¼Œä½¿ç”¨è¿›ç¨‹çš„å†…æ ¸é¡µè¡¨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// translate a kernel virtual address to
</span></span></span><span class=line><span class=cl><span class=c1>// a physical address. only needed for
</span></span></span><span class=line><span class=cl><span class=c1>// addresses on the stack.
</span></span></span><span class=line><span class=cl><span class=c1>// assumes va is page aligned.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>kvmpa</span><span class=p>(</span><span class=n>uint64</span> <span class=n>va</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>off</span> <span class=o>=</span> <span class=n>va</span> <span class=o>%</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>pa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span><span class=o>*</span>
</span></span><span class=line><span class=cl>    <span class=nf>myproc</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>pte</span> <span class=o>=</span> <span class=nf>walk</span><span class=p>(</span><span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span> <span class=p>,</span> <span class=n>va</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// è¿™é‡Œæœ¬æ¥ç¬¬ä¸€ä¸ªå‚æ•°ä¸º kernel_pagetable
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=n>pte</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;kvmpa&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_V</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;kvmpa&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>pa</span> <span class=o>=</span> <span class=nf>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pa</span><span class=o>+</span><span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥è‚¯å®šåœ¨æŸäº›åœ°æ–¹ï¼Œç”¨æˆ·çš„å†…æ ¸é¡µè¡¨ä¼šè¢«ä¿®æ”¹çš„ï¼Œå’Œå…¨å±€é‚£ä¸ªä¸ä¸€æ ·(ç”¨æˆ·çš„å†…æ ¸é¡µè¡¨åº”è¯¥æ˜¯åœ¨ç”¨æˆ·é™·å…¥å†…æ ¸ï¼Œå³åšç³»ç»Ÿè°ƒç”¨æ—¶ä½¿ç”¨çš„)ï¼Œæ­¤å¤„ä½¿ç”¨ç”¨æˆ·çš„å†…æ ¸é¡µè¡¨æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚</p><hr><p>ä»¥ä¸Šæ­¥éª¤å‡å®Œæˆåï¼Œå¯ä»¥é¡ºåˆ©é€šè¿‡è¯¥taskçš„æµ‹è¯•å•¦ğŸ˜ã€‚</p><h2 id=simplify-copyincopyinstr>Simplify <code>copyin/copyinstr</code></h2><p>åœ¨ä¸Šä¸€ä¸ªå®éªŒä¸­çœ‹åˆ°äº†ï¼Œç”±äºç”¨æˆ·ç”¨çš„é¡µè¡¨å’Œå†…æ ¸ä½¿ç”¨çš„é¡µè¡¨ä¸ä¸€æ ·ï¼Œåœ¨åšç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸åï¼Œå†…æ ¸è¦æ‹¿åˆ°ç”¨æˆ·æä¾›çš„ç¼“å†²åŒºçš„æ•°æ®ï¼Œå¿…é¡»è¦ç”¨<code>copyin</code>æ‹¿åˆ°ç”¨æˆ·çš„æ•°æ®ï¼Œ<code>copyinstr</code>æ‹¿åˆ°ç”¨æˆ·æä¾›çš„å­—ç¬¦ä¸²ï¼Œç­‰ç­‰ç­‰ç­‰ã€‚<code>copyin</code>æ‹¿åˆ°ç”¨æˆ·æ•°æ®çš„æ–¹æ³•æ˜¯:æœ‰äº†ç”¨æˆ·çš„<code>pagetable</code>å¯ä»¥ä½¿ç”¨<code>walk</code>å¾—åˆ°ç”¨æˆ·æ•°æ®æ‰€åœ¨çš„çš„<code>pa</code>ï¼Œå†…æ ¸é¡µè¡¨åŸºæœ¬éƒ½æ˜¯æ’ç­‰æ˜ å°„ï¼Œæœ‰äº†ç‰©ç†åœ°å€å°±å¯ä»¥å–å‡ºç”¨æˆ·æ•°æ®ã€‚</p><p>ä»ä¸Šé¢çš„æè¿°å¯ä»¥çœ‹å‡ºï¼Œç”¨æˆ·è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå†…æ ¸å’Œç”¨æˆ·äº¤äº’æ•°æ®å¾ˆéº»çƒ¦ï¼Œå› ä¸ºä½¿ç”¨çš„é¡µè¡¨ä¸ä¸€æ ·ã€‚åœ¨ä¸Šä¸€ä¸ªtaskä¸­ï¼Œæˆ‘ä»¬ç»™æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½åˆ†é…äº†ä¸€ä¸ªå†…æ ¸é¡µè¡¨ï¼Œè¿›ç¨‹éœ€è¦ä½¿ç”¨å†…æ ¸æä¾›çš„åŠŸèƒ½æ—¶ï¼Œé™·å…¥å†…æ ¸åä½¿ç”¨çš„å°±æ˜¯è¯¥è¿›ç¨‹å¯¹åº”çš„å†…æ ¸é¡µè¡¨ã€‚é‚£ä¹ˆï¼Œä¸ºäº†ä½¿å†…æ ¸å¯ä»¥å’Œç”¨æˆ·è¿›ç¨‹æ›´æ–¹ä¾¿çš„äº¤äº’æ•°æ®ï¼Œå…¶å®å¯ä»¥å°†ç”¨æˆ·é¡µè¡¨ä¸­çš„æ˜ å°„å¤åˆ¶åˆ°å¯¹åº”çš„å†…æ ¸é¡µè¡¨ä¸­ï¼Œè¿™æ ·å†…æ ¸å°±å¯ä»¥ç›´æ¥é€šè¿‡ç”¨æˆ·æä¾›çš„åœ°å€æ‹¿åˆ°æˆ–æ”¾å…¥æ•°æ®äº†ã€‚</p><p>å½“ç„¶åœ¨è¿™é‡Œå—å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œé€šè¿‡<a class=link href=../mit-6.s081-page-table-%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90/>ä¸Šä¸€ç¯‡æ–‡ç« </a>çš„è¯¸å¤šä»£ç (å¦‚<code>userinit</code>åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œ<code>exec</code>åˆ›å»ºæ–°è¿›ç¨‹ç­‰ç­‰)éƒ½å¯ä»¥çœ‹å‡ºï¼Œç”¨æˆ·çš„åœ°å€ç©ºé—´ä»0å¢é•¿åˆ°<code>p->sz</code>(<code>p</code>ä¸º<code>struct proc</code>æŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¿›ç¨‹å¯¹åº”çš„ç»“æ„ä½“)ï¼Œå¦‚æœ0~<code>p->sz</code>å’Œå†…æ ¸é¡µè¡¨åŸå…ˆæ˜ å°„çš„ç©ºé—´é‡å ï¼Œé‚£å°±ç³Ÿç³•äº†ã€‚æ‰€å¹¸çš„æ˜¯ï¼Œç”¨æˆ·é™·å…¥åˆ°å†…æ ¸æ—¶ï¼Œå†…æ ¸ä¼šä½¿ç”¨åˆ°çš„åœ°å€ç©ºé—´çš„èŒƒå›´åœ¨<code>PLIC</code>ä»¥ä¸Šï¼Œè¿™ä¹‹ä¸‹çš„ç©ºé—´ä¸ä¼šç”¨åˆ°ï¼Œæ•…åªè¦ç”¨æˆ·è¿›ç¨‹ç©ºé—´å¢é•¿ä¸è¶…è¿‡<code>PLIC</code>ï¼Œå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p><h3 id=é—®é¢˜æè¿°>é—®é¢˜æè¿°</h3><blockquote><p>The kernel&rsquo;s <code>copyin</code> function reads memory pointed to by user pointers. It does this by translating them to physical addresses, which the kernel can directly dereference. It performs this translation by walking the process page-table in software. Your job in this part of the lab is to add user mappings to each process&rsquo;s kernel page table (created in the previous section) that allow <code>copyin</code> (and the related string function <code>copyinstr</code>) to directly dereference user pointers.</p><blockquote><p>Replace the body of <code>copyin</code> in <code>kernel/vm.c</code> with a call to <code>copyin_new</code> (defined in <code>kernel/vmcopyin.c</code>); do the same for <code>copyinstr</code> and <code>copyinstr_new</code>. Add mappings for user addresses to each process&rsquo;s kernel page table so that <code>copyin_new</code> and <code>copyinstr_new</code> work. You pass this assignment if <code>usertests</code> runs correctly and all the <code>make grade</code> tests pass.</p></blockquote><p>Some hints:</p><ul><li>Replace <code>copyin()</code> with a call to <code>copyin_new</code> first, and make it work, before moving on to <code>copyinstr</code>.</li><li>At each point where the kernel changes a process&rsquo;s user mappings, change the process&rsquo;s kernel page table in the same way. Such points include <code>fork()</code>, <code>exec()</code>, and <code>sbrk()</code>.</li><li>Don&rsquo;t forget that to include the first process&rsquo;s user page table in its kernel page table in <code>userinit</code>.</li><li>What permissions do the PTEs for user addresses need in a process&rsquo;s kernel page table? (A page with <code>PTE_U</code> set cannot be accessed in kernel mode.)</li><li>Don&rsquo;t forget about the above-mentioned PLIC limit.</li></ul></blockquote><h3 id=åšæ³•-2>åšæ³•</h3><p>æŒ‰ç…§å‰é¢çš„æè¿°ï¼Œåªéœ€è¦åœ¨ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´å‘ç”Ÿå˜åŒ–ï¼Œå¹¶åœ¨ç”¨æˆ·é¡µè¡¨åšå¯¹åº”æ˜ å°„æ—¶ï¼Œç”¨æˆ·çš„å†…æ ¸é¡µè¡¨ä¹ŸåšåŒæ ·çš„æ˜ å°„å³å¯ã€‚</p><p>é¦–å…ˆä¾æ®é¢˜ç›®ï¼Œå¯ä»¥çŸ¥é“ç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸é¡µè¡¨å…¶å®ç”¨ä¸åˆ°<code>CLINT</code>ï¼Œæ•…ä¿®æ”¹<code>make_kernel_ptbl()</code>å‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>* make a page table that is identical to kernel_pagetable
</span></span></span><span class=line><span class=cl><span class=cm>* this function is used for making a copy of kernel page table
</span></span></span><span class=line><span class=cl><span class=cm>* for each process.
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kt>pagetable_t</span> <span class=nf>make_kernel_ptbl</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=kt>pagetable_t</span> <span class=n>pt</span> <span class=o>=</span> <span class=p>(</span><span class=kt>pagetable_t</span><span class=p>)</span> <span class=nf>kalloc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// uart registers
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>UART0</span><span class=p>,</span> <span class=n>UART0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// virtio mmio disk interface
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>VIRTIO0</span><span class=p>,</span> <span class=n>VIRTIO0</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// CLINT
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// map_helper(pt,CLINT, CLINT, 0x10000, PTE_R | PTE_W);
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// PLIC
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>PLIC</span><span class=p>,</span> <span class=n>PLIC</span><span class=p>,</span> <span class=mh>0x400000</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// map kernel text executable and read-only.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>KERNBASE</span><span class=p>,</span> <span class=n>KERNBASE</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=o>-</span><span class=n>KERNBASE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_X</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// map kernel data and the physical RAM we&#39;ll make use of.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span> <span class=n>PHYSTOP</span><span class=o>-</span><span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>etext</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_W</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// map the trampoline for trap entry/exit to
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// the highest virtual address in the kernel.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>map_helper</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>TRAMPOLINE</span><span class=p>,</span> <span class=p>(</span><span class=n>uint64</span><span class=p>)</span><span class=n>trampoline</span><span class=p>,</span> <span class=n>PGSIZE</span><span class=p>,</span> <span class=n>PTE_R</span> <span class=o>|</span> <span class=n>PTE_X</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚ä¸Šï¼Œå°†<code>CLINT</code>æ˜ å°„åˆ å»ã€‚</p><h4 id=è¾…åŠ©å‡½æ•°>è¾…åŠ©å‡½æ•°</h4><p>æŒ‰ç…§å‰æ–‡æ‰€è¿°ï¼Œéœ€è¦ç»™å†…æ ¸é¡µè¡¨åŒæ­¥åšå’Œç”¨æˆ·é¡µè¡¨ä¸€æ ·çš„æ˜ å°„ï¼Œæ•…åœ¨<code>vm.c</code>ä¸­å†™ä¸€ä¸ªå¤åˆ¶ä¸¤ä¸ªé¡µè¡¨æ˜ å°„çš„è¾…åŠ©å‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// copy page table from src to dst
</span></span></span><span class=line><span class=cl><span class=c1>// virtual address from oldsz to newsz
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>copy_pgtb</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>dst</span><span class=p>,</span><span class=kt>pagetable_t</span> <span class=n>src</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>oldsz</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>newsz</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>a</span> <span class=o>=</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>);</span> <span class=c1>// oldszé‚£ä¸€é¡µåŸæœ¬å·²ç»åˆ†é…å¹¶æ˜ å°„è¿‡äº†ï¼Œæ•…æ­¤å¤„æ˜¯round up
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(;</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=n>newsz</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>a</span> <span class=o>&gt;=</span> <span class=n>PLIC</span><span class=p>)</span>  <span class=c1>// è¦è¶…è¿‡PLICäº†ï¼Œä¸å…è®¸
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>goto</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pte</span> <span class=o>=</span> <span class=nf>walk</span><span class=p>(</span><span class=n>src</span><span class=p>,</span><span class=n>a</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>pte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span> <span class=o>=</span> <span class=nf>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>  <span class=c1>// æ‹¿åˆ°æ˜ å°„åˆ°çš„ç‰©ç†åœ°å€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nf>mappages</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span><span class=n>a</span><span class=p>,</span><span class=n>PGSIZE</span><span class=p>,</span><span class=n>addr</span><span class=p>,</span><span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_R</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// åœ¨dstä¸­åšåŒæ ·çš„æ˜ å°„
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>goto</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>err</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>),(</span><span class=n>a</span> <span class=o>-</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>))</span> <span class=o>/</span> <span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// å‡ºé”™ï¼Œå»é™¤å·²ç»åšäº†çš„æ˜ å°„ï¼Œæ¢å¤åŸæ ·
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢è¿™ä¸ªå‡½æ•°æ˜¯ä»¿ç…§<code>uvmalloc</code>æ¥å†™çš„ï¼Œä½œç”¨æ˜¯ä»<code>src</code>é¡µè¡¨ä¸­å°†è™šæ‹Ÿåœ°å€<code>oldsz</code>åˆ°<code>newsz</code>çš„æ˜ å°„å¤åˆ¶åˆ°é¡µè¡¨<code>dst</code>ä¸­å»ã€‚ä¸Šé¢è¿™ä¸ªä»£ç æ˜¯æ­£ç¡®å¯ç”¨çš„ï¼Œä¹‹å‰æˆ‘æ›¾å†™è¿‡ä¸‹é¢è¿™ä¸ªç‰ˆæœ¬</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// copy page table from src to dst
</span></span></span><span class=line><span class=cl><span class=c1>// virtual address from oldsz to newsz
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>copy_pgtb</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>dst</span><span class=p>,</span><span class=kt>pagetable_t</span> <span class=n>src</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>oldsz</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>newsz</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>a</span> <span class=o>=</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>);</span> <span class=c1>// oldszé‚£ä¸€é¡µåŸæœ¬å·²ç»åˆ†é…å¹¶æ˜ å°„è¿‡äº†ï¼Œæ•…æ­¤å¤„æ˜¯round up
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>uint64</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(;</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=n>newsz</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>a</span> <span class=o>&gt;=</span> <span class=n>PLIC</span><span class=p>)</span>  <span class=c1>// è¦è¶…è¿‡PLICäº†ï¼Œä¸å…è®¸
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>goto</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>addr</span> <span class=o>=</span> <span class=nf>walkaddr</span><span class=p>(</span><span class=n>src</span><span class=p>,</span><span class=n>a</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;copy_pgtb: addr in src not available&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nf>mappages</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span><span class=n>a</span><span class=p>,</span><span class=n>PGSIZE</span><span class=p>,</span><span class=n>addr</span><span class=p>,</span><span class=n>PTE_W</span> <span class=o>|</span> <span class=n>PTE_R</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// åœ¨dstä¸­åšåŒæ ·çš„æ˜ å°„
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>goto</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nl>err</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>),(</span><span class=n>a</span> <span class=o>-</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>))</span> <span class=o>/</span> <span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// å‡ºé”™ï¼Œå»é™¤å·²ç»åšäº†çš„æ˜ å°„ï¼Œæ¢å¤åŸæ ·
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ç›´æ¥é€šè¿‡<code>walkaddr</code>æ‹¿åˆ°<code>va</code>å¯¹åº”çš„<code>pa</code>ï¼Œä½†åœ¨å®é™…è¿è¡Œæ—¶æŠ¥äº†<code>panic</code>ï¼Œ<code>walkaddr</code>æ€»æ˜¯è¿è¡Œä¸æ­£ç¡®ï¼Œ<code>walkaddr</code>ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Look up a virtual address, return the physical address,
</span></span></span><span class=line><span class=cl><span class=c1>// or 0 if not mapped.
</span></span></span><span class=line><span class=cl><span class=c1>// Can only be used to look up user pages.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>walkaddr</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>va</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>pa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>va</span> <span class=o>&gt;=</span> <span class=n>MAXVA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pte</span> <span class=o>=</span> <span class=nf>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>va</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>pte</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_V</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_U</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>pa</span> <span class=o>=</span> <span class=nf>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pa</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°<code>walkaddr</code>åªæŸ¥<code>PTE_U</code>çš„<code>pte</code>ï¼Œåœ¨<a class=link href=../mit-6.s081-page-table-%e4%bb%a3%e7%a0%81%e8%a7%a3%e6%9e%90/#exec>ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·æ ˆå‰ä¸€é¡µæ˜¯<code>guard page</code>ï¼Œè¿™ä¸€é¡µæ²¡æœ‰è®¾ç½®<code>PTE_U</code>ï¼Œæ•…åœ¨å¤åˆ¶æ˜ å°„æ—¶èµ°åˆ°<code>guard page</code>å°±ä¼šå‡ºé”™äº†ï¼Œæ‰€ä»¥è¿˜å¾—æ˜¯ç›´æ¥ç”¨<code>walk</code>ã€‚</p><hr><h4 id=userinit>userinit</h4><p>ç¬¬ä¸€ä¸ªè¿›ç¨‹åœ¨<code>userinit</code>å¤„åˆå§‹åŒ–ï¼Œåœ¨è¯¥å‡½æ•°å†…åŒæ—¶å¤åˆ¶ç”¨æˆ·é¡µè¡¨åˆ°å†…æ ¸é¡µè¡¨å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Set up first user process.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>userinit</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=nf>allocproc</span><span class=p>();</span>  <span class=c1>// set trampoline and trapframe
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>initproc</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// allocate one user page and copy init&#39;s instructions
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// and data into it.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>uvminit</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>initcode</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>initcode</span><span class=p>));</span>  <span class=c1>// allocate one page and copy data in it
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>copy_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>PGSIZE</span><span class=p>);</span>    <span class=c1>// &lt;------æ·»åŠ è¿™å¥è¯
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// prepare for the very first &#34;return&#34; from kernel to user.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>      <span class=c1>// user program counter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span> <span class=o>=</span> <span class=n>PGSIZE</span><span class=p>;</span>  <span class=c1>// user stack pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>safestrcpy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=s>&#34;initcode&#34;</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>cwd</span> <span class=o>=</span> <span class=nf>namei</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=fork>fork</h4><p>é™¤å»ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå…¶ä½™æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯é€šè¿‡<code>fork</code>åˆ›å»ºçš„ï¼Œåœ¨è¯¥å¤„ä¹Ÿè¦åŒæ­¥é¡µè¡¨ï¼Œå¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Create a new process, copying the parent.
</span></span></span><span class=line><span class=cl><span class=c1>// Sets up child kernel stack to return as if from fork() system call.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>fork</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>np</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Allocate process.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>((</span><span class=n>np</span> <span class=o>=</span> <span class=nf>allocproc</span><span class=p>())</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>  <span class=c1>// ä¸‹é¢è¿™ä¸€æ¡ifè¯­å¥ä¸­é™¤äº†å¤åˆ¶çˆ¶è¿›ç¨‹å†…å­˜ï¼ŒåŒæ—¶ä¹Ÿå°†å­è¿›ç¨‹é¡µè¡¨åŒæ­¥åˆ°å­è¿›ç¨‹å†…æ ¸é¡µè¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// Copy user memory from parent to child.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=nf>uvmcopy</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>np</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=o>!</span><span class=nf>copy_pgtb</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>)){</span><span class=c1>//&lt;--- ä¿®æ”¹äº†è¿™ä¸€è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>freeproc</span><span class=p>(</span><span class=n>np</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>parent</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// copy saved user registers.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>*</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Cause fork to return 0 in the child.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>a0</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// increment reference counts on open file descriptors.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NOFILE</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ofile</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>      <span class=n>np</span><span class=o>-&gt;</span><span class=n>ofile</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>filedup</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>ofile</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>cwd</span> <span class=o>=</span> <span class=nf>idup</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>cwd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>safestrcpy</span><span class=p>(</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pid</span> <span class=o>=</span> <span class=n>np</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>np</span><span class=o>-&gt;</span><span class=n>state</span> <span class=o>=</span> <span class=n>RUNNABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>release</span><span class=p>(</span><span class=o>&amp;</span><span class=n>np</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=exec>exec</h4><p><code>exec</code>å‡½æ•°é€šè¿‡è¯»å–<code>elf</code>æ–‡ä»¶ï¼Œé‡æ–°åˆ›å»ºæ–°çš„å†…å­˜åœ°å€ç©ºé—´ï¼Œå¡«å…¥æ–°çš„å†…å®¹ï¼Œåˆ é™¤åŸæ¥çš„å†…å­˜åœ°å€ç©ºé—´ï¼Œå¯¹è¯¥å‡½æ•°åšä¿®æ”¹å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>exec</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>path</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>,</span> <span class=o>*</span><span class=n>last</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>argc</span><span class=p>,</span> <span class=n>sz</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sp</span><span class=p>,</span> <span class=n>ustack</span><span class=p>[</span><span class=n>MAXARG</span><span class=o>+</span><span class=mi>1</span><span class=p>],</span> <span class=n>stackbase</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>elfhdr</span> <span class=n>elf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>inode</span> <span class=o>*</span><span class=n>ip</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proghdr</span> <span class=n>ph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pagetable_t</span> <span class=n>pagetable</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>oldpagetable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>...</span> <span class=c1>// è¿™é‡Œåœ¨è¯»elf,åˆ›å»ºæ–°çš„é¡µè¡¨ï¼Œå¡«å…¥æ–°çš„è¿›ç¨‹çš„å„ä¸ªæ®µï¼Œå¹¶åˆå§‹åŒ–å‘½ä»¤è¡Œå‚æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>  <span class=c1>// Commit to the user image.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>oldpagetable</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span> <span class=o>=</span> <span class=n>pagetable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span> <span class=o>=</span> <span class=n>elf</span><span class=p>.</span><span class=n>entry</span><span class=p>;</span>  <span class=c1>// initial program counter = main
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span> <span class=o>=</span> <span class=n>sp</span><span class=p>;</span> <span class=c1>// initial stack pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>)</span><span class=o>/</span><span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// &lt;-------å»é™¤åŸæ¥çš„æ˜ å°„
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>proc_freepagetable</span><span class=p>(</span><span class=n>oldpagetable</span><span class=p>,</span> <span class=n>oldsz</span><span class=p>);</span> <span class=c1>// å›æ”¶åŸæ¥çš„ç©ºé—´
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>copy_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>))</span>  <span class=c1>// &lt;-----åŒæ­¥å†…æ ¸é¡µè¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span> <span class=nf>vmprint</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>);</span> <span class=c1>// this line is for pagetable lab
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>argc</span><span class=p>;</span> <span class=c1>// this ends up in a0, the first argument to main(argc, argv)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nl>bad</span><span class=p>:</span>
</span></span><span class=line><span class=cl> <span class=p>...</span> <span class=c1>// åé¢åœ¨åšé”™è¯¯å¤„ç†
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=sbrk>sbrk</h4><p><code>sbrk</code>ç³»ç»Ÿè°ƒç”¨ä¼šæ”¹å˜è¿›ç¨‹å¯ç”¨å†…å­˜ç©ºé—´å¤§å°ï¼Œå¯ä»¥å¢åŠ å†…å­˜ä¹Ÿå¯ä»¥å‡å°å†…å­˜ï¼Œå› æ­¤ä¹Ÿä¼šæ”¹å˜ç”¨æˆ·é¡µè¡¨ï¼Œæ•…å†…æ ¸é¡µè¡¨ä¹Ÿè¦åšå¯¹åº”æ”¹å˜ã€‚æŸ¥çœ‹è¯¥ç³»ç»Ÿè°ƒç”¨ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>uint64</span>
</span></span><span class=line><span class=cl><span class=nf>sys_sbrk</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>argint</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>addr</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=nf>growproc</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°<code>growproc</code>å®Œæˆäº†æ”¹å˜å†…å­˜å¤§å°çš„å·¥ä½œï¼Œä¿®æ”¹è¯¥å‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Grow or shrink user memory by n bytes.
</span></span></span><span class=line><span class=cl><span class=c1>// Return 0 on success, -1 on failure.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>growproc</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>sz</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=nf>uvmalloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>copy_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>,</span><span class=n>sz</span><span class=p>)){</span><span class=c1>// &lt;---åŒæ­¥å¢é•¿ 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¸‹é¢è¿™ä¿©å†™åäº†........
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=o>+</span><span class=n>n</span><span class=p>),(</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=p>)</span> <span class=o>-</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=o>+</span><span class=n>n</span><span class=p>))</span> <span class=o>/</span> <span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> <span class=c1>//&lt;---- åŒæ­¥å‡å°‘
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sz</span> <span class=o>=</span> <span class=nf>uvmdealloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=æ’æ›²>æ’æ›²</h5><p>é¢ï¼Œä¹‹å‰å†™ä¸Šé¢é‚£ä¸ª<code>growproc</code>çš„ä»£ç æ—¶ï¼Œ<code>uvmunmap</code>å’Œ<code>uvmdealloc</code>é‚£ä¸¤è¡Œå†™åäº†ï¼Œå¯¼è‡´ä»£ç ä¼šæŠ¥<code>panic: not map</code>ï¼ŒæŸ¥æ‰¾<code>uvmunmap</code>æ—¶å‘ç°æŠ¥<code>panic</code>çš„ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Remove npages of mappings starting from va. va must be
</span></span></span><span class=line><span class=cl><span class=c1>// page-aligned. The mappings must exist.
</span></span></span><span class=line><span class=cl><span class=c1>// Optionally free the physical memory.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>uvmunmap</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>va</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>npages</span><span class=p>,</span> <span class=kt>int</span> <span class=n>do_free</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=n>va</span> <span class=o>%</span> <span class=n>PGSIZE</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;uvmunmap: not aligned&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(</span><span class=n>a</span> <span class=o>=</span> <span class=n>va</span><span class=p>;</span> <span class=n>a</span> <span class=o>&lt;</span> <span class=n>va</span> <span class=o>+</span> <span class=n>npages</span><span class=o>*</span><span class=n>PGSIZE</span><span class=p>;</span> <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>pte</span> <span class=o>=</span> <span class=nf>walk</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;uvmunmap: walk&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_V</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;uvmunmap: not mapped&#34;</span><span class=p>);</span> <span class=c1>// &lt;---- è¿™é‡Œï¼Œå¦‚æœä¸€é¡µæ˜ å°„ä¸å­˜åœ¨ï¼Œå°±ä¼šæŠ¥è¿™ä¸ªpanic
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>(</span><span class=nf>PTE_FLAGS</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>)</span> <span class=o>==</span> <span class=n>PTE_V</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>panic</span><span class=p>(</span><span class=s>&#34;uvmunmap: not a leaf&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>do_free</span><span class=p>){</span>
</span></span><span class=line><span class=cl>      <span class=n>uint64</span> <span class=n>pa</span> <span class=o>=</span> <span class=nf>PTE2PA</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>kfree</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>pa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>pte</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨<code>gdb</code>åœ¨<code>panic</code>å¤„è®¾ç½®æ–­ç‚¹ï¼Œè·‘åˆ°<code>panic</code>äº†åä½¿ç”¨<code>backtrace</code>æŸ¥çœ‹æ ˆå¸§ï¼Œå‘ç°æ˜¯åœ¨<code>exec</code>ä¸­å¦‚ä¸‹ä»£ç çˆ†å‡ºçš„é”™è¯¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Commit to the user image.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>oldpagetable</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span> <span class=o>=</span> <span class=n>pagetable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>epc</span> <span class=o>=</span> <span class=n>elf</span><span class=p>.</span><span class=n>entry</span><span class=p>;</span>  <span class=c1>// initial program counter = main
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>trapframe</span><span class=o>-&gt;</span><span class=n>sp</span> <span class=o>=</span> <span class=n>sp</span><span class=p>;</span> <span class=c1>// initial stack pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>oldsz</span><span class=p>)</span><span class=o>/</span><span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span> <span class=c1>// &lt;------- è¿™ä¸€ä¸ªuvmunmapæŠ¥äº†panic
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>proc_freepagetable</span><span class=p>(</span><span class=n>oldpagetable</span><span class=p>,</span> <span class=n>oldsz</span><span class=p>);</span> <span class=c1>// å›æ”¶åŸæ¥çš„ç©ºé—´
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>copy_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>))</span>  <span class=c1>// &lt;-----åŒæ­¥å†…æ ¸é¡µè¡¨
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>goto</span> <span class=n>bad</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>æ„Ÿè§‰åœ¨<code>growproc</code>é‚£çš„ä¸¤è¡Œä»£ç çš„é¡ºåºæ²¡é—®é¢˜å‘€ï¼Œä¸€ä¸ªæ˜¯åˆ é™¤ç”¨æˆ·çš„é¡µè¡¨ä¸­å¯¹åº”åœ°å€çš„æ˜ å°„å¹¶é‡Šæ”¾å¯¹åº”ç©ºé—´ï¼Œä¸€ä¸ªæ˜¯åˆ é™¤å†…æ ¸é¡µè¡¨å¯¹åº”åœ°å€çš„æ˜ å°„ï¼Œå¥½åƒä»€ä¹ˆé¡ºåºéƒ½è¡Œå‘€ã€‚</p><p>ç„¶åæˆ‘å†™äº†ä¸‹é¢çš„å‡½æ•°æ¥<code>debug</code>ï¼Œä¸‹é¢çš„å‡½æ•°ç”¨äºæŸ¥çœ‹æŸä¸ªé¡µè¡¨ä»0å¼€å§‹æ˜ å°„çš„æœ‰æ•ˆé¡µæ•°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>num_user_pages</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pt</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint64</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>pte_t</span> <span class=o>*</span><span class=n>pte</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span><span class=p>(</span><span class=n>a</span> <span class=o>&lt;</span> <span class=n>PLIC</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>pte</span> <span class=o>=</span> <span class=nf>walk</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=n>a</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>pte</span> <span class=o>||</span> <span class=o>!</span><span class=p>(</span><span class=o>*</span><span class=n>pte</span> <span class=o>&amp;</span> <span class=n>PTE_V</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>num</span> <span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>+=</span> <span class=n>PGSIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¥ç€ä¿®æ”¹<code>growproc</code>ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>growproc</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>uint</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>sz</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>sz</span> <span class=o>=</span> <span class=nf>uvmalloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nf>copy_pgtb</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span><span class=p>,</span><span class=n>sz</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>sz</span> <span class=o>=</span> <span class=nf>uvmdealloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;right before uvmunmap in growproc</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=o>+</span><span class=n>n</span><span class=p>),(</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=p>)</span> <span class=o>-</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=o>+</span><span class=n>n</span><span class=p>))</span> <span class=o>/</span> <span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;right after uvmunmap in growproc</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt;&gt;&gt;&gt;growproc done. pid = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;--- user pgtbl:%d</span><span class=se>\n</span><span class=s>--- kernel pgtbl:%d</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>num_user_pages</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>),</span><span class=nf>num_user_pages</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>=</span> <span class=n>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿è¡Œ<code>usertests</code>æ—¶å‘ç°æœ‰è¿™æ ·çš„è¾“å‡º</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>right before uvmunmap in growproc
</span></span><span class=line><span class=cl>right after uvmunmap in growproc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt;&gt;&gt;&gt;growproc done. pid = 20
</span></span><span class=line><span class=cl>--- user pgtbl:32082
</span></span><span class=line><span class=cl>--- kernel pgtbl:32081
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>right before uvmunmap in growproc
</span></span><span class=line><span class=cl>right after uvmunmap in growproc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt;&gt;&gt;&gt;growproc done. pid = 20
</span></span><span class=line><span class=cl>--- user pgtbl:32081
</span></span><span class=line><span class=cl>--- kernel pgtbl:32080
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>éœ‡æƒŠï¼Œåœ¨<code>growproc</code>ç”¨äºå‡å°å†…å­˜ç©ºé—´æ—¶<code>kernel pagetbl</code>å°‘äº†ä¸€é¡µï¼Œæ€ä¹ˆè‚¥äº‹ï¼Œå†ä»”ç»†çœ‹çœ‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>sz</span> <span class=o>=</span> <span class=nf>uvmdealloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>sz</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>uvmunmap</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>kernel_pgtb</span><span class=p>,</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=o>+</span><span class=n>n</span><span class=p>),(</span><span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=p>)</span> <span class=o>-</span> <span class=nf>PGROUNDUP</span><span class=p>(</span><span class=n>sz</span><span class=o>+</span><span class=n>n</span><span class=p>))</span> <span class=o>/</span> <span class=n>PGSIZE</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>åŸæ¥å‰é¢çš„<code>sz = uvmdealloc(...)</code>å·²ç»æ”¹å˜äº†<code>sz</code>çš„å¤§å°ğŸ˜‡ï¼Œåé¢<code>uvmunmap</code>ç”¨çš„<code>sz</code>æ˜¯é”™çš„&mldr;&mldr;</p><p>æ‰€ä»¥è¿™ä¸¤å¥æ¢è¿‡æ¥å<code>sz</code>å°±å¯¹äº†ï¼Œå°±èƒ½é€šè¿‡æ‰€æœ‰æµ‹è¯•äº†ã€‚</p><hr><h4 id=copyincopyinstr><code>copyin/copyinstr</code></h4><p>ä¿®æ”¹åŸæ¥çš„<code>copyin/copyinstr</code>è¿™ä¸¤ä¸ªå‡½æ•°å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Copy a null-terminated string from user to kernel.
</span></span></span><span class=line><span class=cl><span class=c1>// Copy bytes to dst from virtual address srcva in a given page table,
</span></span></span><span class=line><span class=cl><span class=c1>// until a &#39;\0&#39;, or max.
</span></span></span><span class=line><span class=cl><span class=c1>// Return 0 on success, -1 on error.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>copyinstr</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>srcva</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>max</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>copyinstr_new</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>srcva</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>max</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>copyinstr_new</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span><span class=n>dst</span><span class=p>,</span><span class=n>srcva</span><span class=p>,</span><span class=n>max</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Copy from user to kernel.
</span></span></span><span class=line><span class=cl><span class=c1>// Copy len bytes to dst from virtual address srcva in a given page table.
</span></span></span><span class=line><span class=cl><span class=c1>// Return 0 on success, -1 on error.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>copyin</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>srcva</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=nf>copyin_new</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>srcva</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>copyin_new</span><span class=p>(</span><span class=n>pagetable</span><span class=p>,</span> <span class=n>dst</span><span class=p>,</span> <span class=n>srcva</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä¸­<code>copyin_new</code>å’Œ<code>copyinstr</code>æ˜¯è¿™ä¸ªå®éªŒæœ¬æ¥å°±å·²ç»å®ç°å¥½äº†çš„ï¼Œå…¶å®å°±æ˜¯ç®€å•çš„ç›´æ¥å¤åˆ¶æ•°æ®ï¼Œæˆªå–<code>copyin_new</code>ä»£ç å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>memmove</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>src</span><span class=p>,</span> <span class=n>uint</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>s</span> <span class=o>=</span> <span class=n>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>d</span> <span class=o>=</span> <span class=n>dst</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>s</span> <span class=o>&lt;</span> <span class=n>d</span> <span class=o>&amp;&amp;</span> <span class=n>s</span> <span class=o>+</span> <span class=n>n</span> <span class=o>&gt;</span> <span class=n>d</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>+=</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>n</span><span class=o>--</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>*--</span><span class=n>d</span> <span class=o>=</span> <span class=o>*--</span><span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>n</span><span class=o>--</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=n>d</span><span class=o>++</span> <span class=o>=</span> <span class=o>*</span><span class=n>s</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>dst</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>copyin_new</span><span class=p>(</span><span class=kt>pagetable_t</span> <span class=n>pagetable</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>srcva</span><span class=p>,</span> <span class=n>uint64</span> <span class=n>len</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>proc</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>myproc</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>srcva</span> <span class=o>&gt;=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>||</span> <span class=n>srcva</span><span class=o>+</span><span class=n>len</span> <span class=o>&gt;=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>sz</span> <span class=o>||</span> <span class=n>srcva</span><span class=o>+</span><span class=n>len</span> <span class=o>&lt;</span> <span class=n>srcva</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>memmove</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=n>dst</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>srcva</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span> <span class=c1>// ç›´æ¥å¤åˆ¶æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>stats</span><span class=p>.</span><span class=n>ncopyin</span><span class=o>++</span><span class=p>;</span>   <span class=c1>// XXX lock  // è¿™è²Œä¼¼æ˜¯æµ‹è¯•ç”¨çš„ä»£ç ï¼Ÿ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=å°¾å£°>å°¾å£°</h2><p>åšå®Œä¸Šé¢çš„æ‰€æœ‰ä¿®æ”¹ï¼Œå°±å¯ä»¥é€šè¿‡æ‰€æœ‰çš„æµ‹è¯•å•¦ğŸ˜‹ğŸ˜‹</p><p>ä¸Šä¸ªå›¾çºªå¿µä¸€ä¸‹</p><p><img src=/aniya_blog/p/mit-6.s081-pagetable-lab/assets/image-20230120162551565.png width=716 height=698 srcset="/aniya_blog/p/mit-6.s081-pagetable-lab/assets/image-20230120162551565_hub77c20e2cb20bdad2a1a10db0e28550d_98170_480x0_resize_box_3.png 480w, /aniya_blog/p/mit-6.s081-pagetable-lab/assets/image-20230120162551565_hub77c20e2cb20bdad2a1a10db0e28550d_98170_1024x0_resize_box_3.png 1024w" loading=lazy alt=é€šè¿‡æ‰€æœ‰æµ‹è¯• class=gallery-image data-flex-grow=102 data-flex-basis=246px></p><p>åšå®Œè¿™ä¸ªå®éªŒï¼Œä¹Ÿç®—æ˜¯å®é™…ä½¿ç”¨è¿‡äº†ä¼ è¯´ä¸­çš„é¡µè¡¨å•¦ï¼Œè™½ç„¶æ•´ä½“ä½¿ç”¨é¡µè¡¨çš„æ–¹å¼éƒ½æ¯”è¾ƒç®€å•ï¼Œä½†æ¯•ç«Ÿæ˜¯ä¸€ä¸ªçœŸæ­£çš„è·‘åœ¨riscvä¸Šçš„ä¸œè¥¿ï¼Œå’Œçº¯ç†è®ºç›¸æ¯”å®é™…å¤šäº†ï¼Œè¿˜ç®—æ˜¯æœ‰æ‰€æ”¶è·ğŸ˜ã€‚</p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/aniya_blog/p/mit-6.s081-page-table-%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/><div class=article-image><img src=/aniya_blog/p/mit-6.s081-page-table-%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90/wallpaper.1a7c164d7588e479a8cd3b0543a28107_hudb94877ecea93d4ab13b1a424f076a8e_2205015_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post MIT 6.S081 page table ä»£ç è§£æ" data-hash="md5-GnwWTXWI5HmozTsFQ6KBBw=="></div><div class=article-details><h2 class=article-title>MIT 6.S081 page table ä»£ç è§£æ</h2></div></a></article><article class=has-image><a href=/aniya_blog/p/%E9%97%B2%E8%B0%88gdb/><div class=article-image><img src=/aniya_blog/p/%E9%97%B2%E8%B0%88gdb/piano.f90597ada3d1ee9a0f72689877b34d83_hu28da5375bae764b9601c6414097b4ddd_1403895_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post é—²è°ˆã€gdb" data-hash="md5-+QWXraPR7poPcmiYd7NNgw=="></div><div class=article-details><h2 class=article-title>é—²è°ˆã€gdb</h2></div></a></article><article class=has-image><a href=/aniya_blog/p/lab2-system-calls/><div class=article-image><img src=/aniya_blog/p/lab2-system-calls/cover.1b1c2c8a3a0436f8c683de842e6ad9a0_hu7ace472778f385b50e7c8f287dbb6c46_2544271_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post lab2: system calls" data-hash="md5-GxwsijoENvjGg96ELmrZoA=="></div><div class=article-details><h2 class=article-title>lab2: system calls</h2></div></a></article><article class=has-image><a href=/aniya_blog/p/os_util_lab/><div class=article-image><img src=/aniya_blog/p/os_util_lab/saber2.d3cf7db7f3e39c28f3c1c04197864dea_hu583263cbbee05d2c263b501713a891d4_83776_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post OS_util_lab" data-hash="md5-0899t/PjnCjzwcBBl4ZN6g=="></div><div class=article-details><h2 class=article-title>OS_util_lab</h2></div></a></article><article class=has-image><a href=/aniya_blog/p/xv6-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/><div class=article-image><img src=/aniya_blog/p/xv6-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/wallpaper.74540f2c69533900a024c238ae79d45e_hu0ff37ebbb98d2b42bafbb67ed8d5243a_153541_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post xv6 ç¯å¢ƒé…ç½®" data-hash="md5-dFQPLGlTOQCgJMI4rnnUXg=="></div><div class=article-details><h2 class=article-title>xv6 ç¯å¢ƒé…ç½®</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 Aniya's Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/aniya_blog/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>